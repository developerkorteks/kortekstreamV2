<!DOCTYPE html>
<html lang="id" class="light">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
        
        <!-- SEO Meta Tags -->
        <title>
            {% block title %}
                {{ title }} | KortekStream - Streaming Anime Terbaik Indonesia
            {% endblock title %}
        </title>
        
        <meta name="description" content="{% block description %}KortekStream - Platform streaming anime terbaik di Indonesia. Nonton anime subtitle Indonesia gratis dengan kualitas HD. Update episode terbaru setiap hari, Tentu juga ada Doujin, Hentai, Drakor,Movies, Anime, etc..{% endblock description %}" />
        <meta name="keywords" content="{% block keywords %}anime, streaming, subtitle indonesia, anime gratis, nonton anime, anime HD, anime terbaru, anime ongoing, gomunime, samehadaku, otakudesu, kortekstream, kortekstream online , samehadaku ol, samehdaku now , kurama nime, anime indo , anime gratis sub indo , anime tanpa iklan , download gratis anime , nonton hentai , nonton doujin , anime terbaru, samehadaku , samehadaku , anime, movie , lk21, drakor , donghua gratis bebas  iklan , download donghua, download doujin , download film tanpa iklan , film gratis , netflix{% endblock keywords %}" />
        <meta name="author" content="KortekStream" />
        <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
        
        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="{% block og_type %}website{% endblock og_type %}" />
        <meta property="og:url" content="{% block og_url %}{{ request.build_absolute_uri }}{% endblock og_url %}" />
        <meta property="og:title" content="{% block og_title %}{{ title }} | KortekStream{% endblock og_title %}" />
        <meta property="og:description" content="{% block og_description %}KortekStream - Platform streaming anime terbaik di Indonesia{% endblock og_description %}" />
        <meta property="og:image" content="{% block og_image %}{% load static %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/og-image.jpg' %}{% endblock og_image %}" />
        <meta property="og:site_name" content="KortekStream" />
        <meta property="og:locale" content="id_ID" />
        
        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content="{% block twitter_url %}{{ request.build_absolute_uri }}{% endblock twitter_url %}" />
        <meta property="twitter:title" content="{% block twitter_title %}{{ title }} | KortekStream{% endblock twitter_title %}" />
        <meta property="twitter:description" content="{% block twitter_description %}KortekStream - Platform streaming anime terbaik di Indonesia{% endblock twitter_description %}" />
        <meta property="twitter:image" content="{% block twitter_image %}{% load static %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/og-image.jpg' %}{% endblock twitter_image %}" />
        
        <!-- Canonical URL -->
        <link rel="canonical" href="{% block canonical_url %}{{ request.build_absolute_uri }}{% endblock canonical_url %}" />
        
        <!-- Favicon -->
        <link rel="icon" type="image/x-icon" href="{% static 'images/og-image.jpg' %}" />
        <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/og-image.jpg' %}" />
        <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/og-image.jpg' %}" />
        <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/og-image.jpg' %}" />
        <link rel="manifest" href="{% static 'site.webmanifest' %}" />
        
        <!-- Search Integration -->
        <link rel="search" type="application/opensearchdescription+xml" title="KortekStream Search" href="/opensearch.xml" />
        
        <!-- Advanced SEO Meta Tags -->
        <meta name="referrer" content="no-referrer-when-downgrade" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="default" />
        <meta name="apple-mobile-web-app-title" content="KortekStream" />
        <meta name="msapplication-TileColor" content="#F59E0B" />
        <meta name="msapplication-config" content="{% static 'browserconfig.xml' %}" />
        
        <!-- Performance Hints -->
        <meta name="google" content="notranslate" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="pinterest" content="nopin" />
        
        <!-- Theme Color -->
        <meta name="theme-color" content="#F59E0B" media="(prefers-color-scheme: light)" />
        <meta name="theme-color" content="#E50914" media="(prefers-color-scheme: dark)" />
        
        <!-- DNS Prefetch for Performance -->
        <link rel="dns-prefetch" href="//fonts.googleapis.com" />
        <link rel="dns-prefetch" href="//cdnjs.cloudflare.com" />
        <link rel="dns-prefetch" href="//unpkg.com" />
        <link rel="dns-prefetch" href="//apigatway.humanmade.my.id" />
        
        <!-- Preconnect for Critical Third-party Resources -->
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        
        <!-- Geo and Language Tags -->
        <meta name="geo.region" content="ID" />
        <meta name="geo.country" content="Indonesia" />
        <meta name="geo.placename" content="Jakarta" />
        
        <!-- Language and Locale -->
        <meta http-equiv="content-language" content="id-ID" />
        <meta name="language" content="Indonesian" />
        
        <!-- Content Classification -->
        <meta name="rating" content="general" />
        <meta name="distribution" content="global" />
        <meta name="copyright" content="KortekStream Â© {% now 'Y' %}" />
        
        <!-- Advanced SEO -->
        <meta name="robots" content="{% block meta_robots %}index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1{% endblock %}" />
        <meta name="googlebot" content="index, follow" />
        <meta name="bingbot" content="index, follow" />
        
        <!-- Social Media Optimization -->
        <meta name="twitter:creator" content="@KortekStream" />
        <meta name="twitter:site" content="@KortekStream" />
        
        <!-- Additional Open Graph -->
        <meta property="og:locale" content="id_ID" />
        <meta property="og:locale:alternate" content="en_US" />
        
        <!-- Additional Open Graph Image Properties -->
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="630" />
        <meta property="og:image:alt" content="{% block og_image_alt %}KortekStream - Platform Streaming Anime Terbaik{% endblock og_image_alt %}" />
        
        <!-- Hreflang for Multi-language SEO -->
        <link rel="alternate" hreflang="id" href="{{ request.build_absolute_uri }}" />
        <link rel="alternate" hreflang="en" href="{{ request.build_absolute_uri }}" />
        <link rel="alternate" hreflang="x-default" href="{{ request.build_absolute_uri }}" />
        <meta property="article:publisher" content="https://facebook.com/kortekstream" />
        
        <!-- Twitter Enhanced -->
        <meta name="twitter:image:alt" content="{% block twitter_image_alt %}KortekStream - Streaming Anime Indonesia{% endblock twitter_image_alt %}" />
        
        <!-- Article/Content specific (for blog posts, news) -->
        {% block article_meta %}{% endblock article_meta %}
        
        <!-- Video specific meta -->
        {% block video_meta %}{% endblock video_meta %}
        
        <!-- Prevent Theme Flicker -->
        <script>
            (function() {
                const theme = localStorage.getItem('theme');
                const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const shouldBeDark = theme === 'dark' || (!theme && systemDark);
                
                if (shouldBeDark) {
                    document.documentElement.classList.add('dark');
                    document.documentElement.classList.remove('light');
                } else {
                    document.documentElement.classList.add('light');
                    document.documentElement.classList.remove('dark');
                }
            })();
        </script>

        <!-- Performance Optimizations -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        
        <!-- Preload critical CSS files -->
        <link rel="preload" href="{% static 'css/output.css' %}" as="style">
        <link rel="preload" href="{% static 'css/modern-animations.css' %}" as="style">
        
        <!-- Preload fonts with reduced weight variants for faster loading -->
        <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap"></noscript>

        <!-- Critical CSS (always inlined for performance) -->
        <style>
            {% load static %}
            /* Critical CSS inlined for performance */
            html { background-color: #ffffff; color: #111827; }
            html.dark { background-color: #0f0f0f; color: #f9fafb; }
            body { font-family: 'Poppins', 'Inter', system-ui, -apple-system, sans-serif; line-height: 1.6; margin: 0; padding: 0; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }
            nav { position: sticky; top: 0; z-index: 50; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); background-color: rgba(255, 255, 255, 0.8); border-bottom: 1px solid rgba(229, 231, 235, 0.2); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; }
            .dark nav { background-color: rgba(17, 24, 39, 0.8); border-bottom-color: rgba(75, 85, 99, 0.2); }
            
            /* Additional critical styles to prevent FOUC (Flash of Unstyled Content) */
            .modern-card { background-color: rgba(255, 255, 255, 0.8); border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow: hidden; }
            .dark .modern-card { background-color: rgba(31, 41, 55, 0.8); }
            .container { width: 100%; margin-left: auto; margin-right: auto; }
            .text-center { text-align: center; }
            .font-bold { font-weight: 700; }
            .text-gray-800 { color: #1f2937; }
            .dark .text-gray-800 { color: #f9fafb; }
            .dark .text-white { color: #ffffff; }
            .mb-4 { margin-bottom: 1rem; }
            .mb-8 { margin-bottom: 2rem; }
            .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
            .px-4 { padding-left: 1rem; padding-right: 1rem; }
            .mx-auto { margin-left: auto; margin-right: auto; }
            .flex { display: flex; }
            .items-center { align-items: center; }
            .justify-center { justify-content: center; }
            .space-x-6 > * + * { margin-left: 1.5rem; }
            .rounded-2xl { border-radius: 1rem; }
            .text-lg { font-size: 1.125rem; }
            .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
            
            /* Prevent animation flicker on load */
            .stagger-item { opacity: 1; }
            body:not(.loaded) .stagger-item { opacity: 0; }
            body:not(.loaded) .animate-fade-in { opacity: 0; }
            body:not(.loaded) .animate-slide-up { opacity: 0; transform: translateY(20px); }
        </style>
        
        <!-- Main CSS - load directly for faster rendering -->
        <link rel="stylesheet" href="{% static 'css/output.css' %}">
        
        <!-- Modern CSS Framework -->
        <link rel="stylesheet" href="{% static 'css/modern-animations.css' %}">

        <style>
            /* Enhanced Base Styles */
            * {
                box-sizing: border-box;
            }

            body {
                font-family: 'Poppins', 'Inter', system-ui, -apple-system, sans-serif;
                line-height: 1.6;
                scroll-behavior: smooth;
            }

            /* Modern Glass Morphism Background */
            .gradient-bg {
                background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.1) 0%,
                    rgba(255, 255, 255, 0.05) 100%);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .dark .gradient-bg {
                background: linear-gradient(135deg,
                    rgba(20, 20, 20, 0.9) 0%,
                    rgba(38, 38, 38, 0.8) 100%);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.05);
            }

            /* Enhanced Text Clamp */
            .line-clamp-1 {
                display: -webkit-box;
                -webkit-line-clamp: 1;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            .line-clamp-2 {
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            .line-clamp-3 {
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            /* Responsive utilities */
            @media (max-width: 640px) {
                .container {
                    padding-left: 1rem;
                    padding-right: 1rem;
                }

                .text-responsive {
                    font-size: 0.875rem;
                    line-height: 1.25rem;
                }

                .modern-card {
                    border-radius: 1rem;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                }

                .shadow-responsive {
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                }

                /* Mobile card optimizations */
                .modern-card img {
                    border-radius: 0.75rem;
                }

                .modern-card h3 {
                    font-size: 0.75rem;
                    line-height: 1rem;
                }

                /* Smaller badges on mobile */
                .modern-card .badge {
                    font-size: 0.65rem;
                    padding: 0.125rem 0.375rem;
                }
            }

            @media (min-width: 640px) and (max-width: 768px) {
                .text-responsive {
                    font-size: 1rem;
                    line-height: 1.5rem;
                }
            }

            @media (min-width: 768px) {
                .text-responsive {
                    font-size: 1.125rem;
                    line-height: 1.75rem;
                }
            }

            /* Touch-friendly interactive elements */
            @media (hover: none) and (pointer: coarse) {
                .card-hover:hover {
                    transform: none;
                }

                .group:hover .opacity-0 {
                    opacity: 1;
                }

                .group:hover .transform {
                    transform: translateY(0);
                }
            }

            /* Modern Card Hover Effects */
            .card-hover {
                transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
                border: 1px solid transparent;
                position: relative;
                overflow: hidden;
            }

            .card-hover::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(255, 255, 255, 0.1),
                    transparent
                );
                transition: left 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
                z-index: 1;
            }

            .card-hover:hover::before {
                left: 100%;
            }

            .light .card-hover:hover {
                transform: translateY(-12px) scale(1.02);
                border-color: rgba(245, 158, 11, 0.3);
                box-shadow:
                    0 25px 50px -12px rgba(0, 0, 0, 0.15),
                    0 0 30px rgba(245, 158, 11, 0.2);
            }

            .dark .card-hover:hover {
                transform: translateY(-12px) scale(1.02);
                border-color: rgba(229, 9, 20, 0.3);
                box-shadow:
                    0 25px 50px -12px rgba(0, 0, 0, 0.4),
                    0 0 30px rgba(229, 9, 20, 0.2);
            }

            /* Enhanced Scrollbar */
            .custom-scrollbar::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }

            .light .custom-scrollbar::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.05);
                border-radius: 12px;
            }

            .light .custom-scrollbar::-webkit-scrollbar-thumb {
                background: linear-gradient(180deg, #F59E0B, #D97706);
                border-radius: 12px;
                border: 2px solid transparent;
                background-clip: content-box;
            }

            .light .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(180deg, #D97706, #B45309);
            }

            .dark .custom-scrollbar::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 12px;
            }

            .dark .custom-scrollbar::-webkit-scrollbar-thumb {
                background: linear-gradient(180deg, #E50914, #B81D24);
                border-radius: 12px;
                border: 2px solid transparent;
                background-clip: content-box;
            }

            .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(180deg, #B81D24, #831018);
            }

            /* Loading States */
            .loading-skeleton {
                background: linear-gradient(
                    90deg,
                    #f0f0f0 25%,
                    #e0e0e0 50%,
                    #f0f0f0 75%
                );
                background-size: 200% 100%;
                animation: shimmer 2s infinite;
            }

            .dark .loading-skeleton {
                background: linear-gradient(
                    90deg,
                    #2a2a2a 25%,
                    #1a1a1a 50%,
                    #2a2a2a 75%
                );
                background-size: 200% 100%;
            }

            /* Page Transition */
            .page-transition {
                opacity: 0;
                transform: translateY(20px);
                animation: slideUp 0.6s ease-out forwards;
                animation-delay: 0.1s;
            }

            /* Focus States */
            .focus-ring {
                transition: all 0.2s ease;
            }

            .focus-ring:focus {
                outline: none;
                ring: 2px;
                ring-color: rgba(245, 158, 11, 0.5);
                ring-offset: 2px;
            }

            .dark .focus-ring:focus {
                ring-color: rgba(229, 9, 20, 0.5);
            }
        </style>



        <!-- Performance Hints -->
        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="dns-prefetch" href="//fonts.gstatic.com">
        <!-- Tailwind CSS dikelola melalui NPM, bukan CDN -->
        
        {% block extra_css %}
        {% endblock extra_css %}
        {% block extra_head %}
        {% endblock extra_head %}
    </head>
    <body class="bg-gradient-to-br from-gray-50 via-white to-gray-100 dark:bg-gradient-to-br dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 text-gray-900 dark:text-gray-100 min-h-screen transition-all duration-300 overflow-x-hidden">
        
        <!-- Advanced Structured Data (Organization) -->
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "name": "KortekStream",
            "alternateName": "Kortek Stream",
            "url": "{{ request.scheme }}://{{ request.get_host }}",
            "logo": {
                "@type": "ImageObject",
                "url": "{{ request.scheme }}://{{ request.get_host }}{% static 'images/logo.png' %}"
            },
            "description": "Platform streaming anime terbaik di Indonesia dengan subtitle Indonesia gratis",
            "address": {
                "@type": "PostalAddress",
                "addressCountry": "ID",
                "addressRegion": "DKI Jakarta",
                "addressLocality": "Jakarta"
            },
            "contactPoint": {
                "@type": "ContactPoint",
                "contactType": "customer service",
                "email": "admin@kortekstream.com"
            },
            "sameAs": [
                "https://facebook.com/kortekstream",
                "https://twitter.com/kortekstream",
                "https://instagram.com/kortekstream"
            ],
            "potentialAction": {
                "@type": "SearchAction",
                "target": "{{ request.scheme }}://{{ request.get_host }}/search/?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>
        
        <!-- Website Structured Data -->
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebSite",
            "name": "KortekStream",
            "alternateName": "Kortek Stream Indonesia",
            "url": "{{ request.scheme }}://{{ request.get_host }}",
            "description": "Platform streaming anime terbaik di Indonesia dengan subtitle Indonesia gratis. Nonton anime terbaru dan terpopuler dengan kualitas HD.",
            "inLanguage": "id-ID",
            "isAccessibleForFree": true,
            "potentialAction": {
                "@type": "SearchAction",
                "target": {
                    "@type": "EntryPoint",
                    "urlTemplate": "{{ request.scheme }}://{{ request.get_host }}/search/?q={search_term_string}"
                },
                "query-input": "required name=search_term_string"
            },
            "publisher": {
                "@type": "Organization",
                "name": "KortekStream"
            }
        }
        </script>
        
        <!-- Page-specific Structured Data Block -->
        {% block page_structured_data %}{% endblock %}
        
        <!-- Enhanced Theme Toggle Button -->
        <div class="fixed top-6 right-6 z-50">
            <button id="theme-toggle" class="group relative p-3 rounded-full bg-white/80 dark:bg-korteks-gray/80 backdrop-blur-md border border-gray-200/50 dark:border-gray-700/50 text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-korteks-darkgray shadow-lg hover:shadow-xl transition-all duration-300 ease-out hover:scale-110">
                <!-- Enhanced Sun icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden dark:block transition-all duration-300 group-hover:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <!-- Enhanced Moon icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 block dark:hidden transition-all duration-300 group-hover:-rotate-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
                <!-- Tooltip -->
                <div class="absolute -bottom-12 right-0 bg-gray-900 dark:bg-white text-white dark:text-gray-900 px-3 py-1 rounded-lg text-sm opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0 pointer-events-none whitespace-nowrap">
                    Switch Theme
                    <div class="absolute -top-1 right-4 w-2 h-2 bg-gray-900 dark:bg-white transform rotate-45"></div>
                </div>
            </button>
        </div>

        <!-- Enhanced Background Pattern -->
        <div class="fixed inset-0 -z-10 overflow-hidden">
            <!-- Animated background shapes -->
            <div class="absolute -top-40 -right-32 w-80 h-80 bg-gradient-to-br from-gold-200/20 to-gold-400/10 dark:from-korteks-red/10 dark:to-korteks-darkred/5 rounded-full blur-3xl animate-float"></div>
            <div class="absolute -bottom-40 -left-32 w-96 h-96 bg-gradient-to-tr from-gold-300/15 to-gold-500/5 dark:from-korteks-red/5 dark:to-korteks-darkred/10 rounded-full blur-3xl animate-float" style="animation-delay: -3s;"></div>
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-gradient-to-r from-gold-100/10 via-transparent to-gold-200/10 dark:from-korteks-red/5 dark:via-transparent dark:to-korteks-darkred/5 rounded-full blur-3xl animate-pulse opacity-50"></div>
        </div>
        
        {% block content %}
        {% endblock content %}
        
        <!-- Enhanced Theme Toggle Script -->
        <script>
            // Enhanced theme management with flicker prevention
            const initializeTheme = () => {
                const theme = localStorage.getItem('theme');
                const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const shouldBeDark = theme === 'dark' || (!theme && systemDark);
                
                if (shouldBeDark) {
                    document.documentElement.classList.add('dark');
                    document.documentElement.classList.remove('light');
                } else {
                    document.documentElement.classList.add('light');
                    document.documentElement.classList.remove('dark');
                }
            };

            // Initialize theme immediately to prevent flicker
            initializeTheme();

            // Enhanced theme toggle with smooth transitions
            document.addEventListener('DOMContentLoaded', function() {
                const themeToggle = document.getElementById('theme-toggle');

                if (themeToggle) {
                    themeToggle.addEventListener('click', function(e) {
                        e.preventDefault();

                        // Add loading state
                        this.style.pointerEvents = 'none';
                        this.style.transform = 'scale(0.95)';

                        // Theme transition with animation
                        document.documentElement.style.transition = 'background-color 0.3s ease, color 0.3s ease';

                        // Use requestAnimationFrame for smoother transition
                        requestAnimationFrame(() => {
                            if (document.documentElement.classList.contains('dark')) {
                                document.documentElement.classList.remove('dark');
                                document.documentElement.classList.add('light');
                                localStorage.setItem('theme', 'light');
                            } else {
                                document.documentElement.classList.remove('light');
                                document.documentElement.classList.add('dark');
                                localStorage.setItem('theme', 'dark');
                            }

                            // Reset button state after transition
                            setTimeout(() => {
                                this.style.pointerEvents = '';
                                this.style.transform = '';
                                document.documentElement.style.transition = '';
                            }, 300);
                        });
                    });
                }

                // Listen for system theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                    if (!localStorage.getItem('theme')) {
                        initializeTheme();
                    }
                });
            });

            // Page load animation - optimized for faster rendering
            document.addEventListener('DOMContentLoaded', function() {
                // Add a small delay to ensure CSS is applied first
                setTimeout(function() {
                    document.body.classList.add('loaded');
                    
                    // Animate elements with stagger but with shorter delays
                    const animateElements = document.querySelectorAll('.stagger-item');
                    animateElements.forEach((el, index) => {
                        // Reduce animation delay to make it faster
                        el.style.animationDelay = `${index * 0.05}s`;
                    });
                }, 50); // Small delay to ensure CSS is loaded
            });

            // Smooth scroll behavior
            document.addEventListener('DOMContentLoaded', function() {
                const links = document.querySelectorAll('a[href^="#"]');
                links.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const target = document.querySelector(this.getAttribute('href'));
                        if (target) {
                            target.scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }
                    });
                });
            });

            // Performance optimization
            const optimizeScroll = () => {
                let ticking = false;

                const updateScrollEffects = () => {
                    const scrollY = window.scrollY;
                    const cards = document.querySelectorAll('.modern-card');

                    cards.forEach((card, index) => {
                        const rect = card.getBoundingClientRect();
                        const isVisible = rect.top < window.innerHeight && rect.bottom > 0;

                        if (isVisible && !card.classList.contains('animated')) {
                            card.classList.add('animated');
                            card.style.animationDelay = `${index * 0.1}s`;
                        }
                    });

                    ticking = false;
                };

                window.addEventListener('scroll', () => {
                    if (!ticking) {
                        requestAnimationFrame(updateScrollEffects);
                        ticking = true;
                    }
                });
            };

            // Initialize scroll optimization
            document.addEventListener('DOMContentLoaded', optimizeScroll);
        </script>
        
        <script src="{% static 'js/user_activity.js' %}" defer></script>
        {% block extra_js %}
        {% endblock extra_js %}

        <!-- Global Structured Data -->
        {% block structured_data %}
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "name": "KortekStream",
            "alternateName": "Kortek Stream",
            "url": "{{ request.scheme }}://{{ request.get_host }}",
            "logo": {
                "@type": "ImageObject",
                "url": "{{ request.scheme }}://{{ request.get_host }}{% static 'images/logo.png' %}",
                "width": "300",
                "height": "100"
            },
            "description": "Platform streaming anime terbaik di Indonesia dengan subtitle Indonesia. Nonton anime gratis dengan kualitas HD.",
            "sameAs": [
                "https://facebook.com/kortekstream",
                "https://twitter.com/kortekstream",
                "https://instagram.com/kortekstream",
                "https://youtube.com/c/kortekstream"
            ],
            "address": {
                "@type": "PostalAddress",
                "addressCountry": "ID",
                "addressRegion": "Indonesia"
            },
            "contactPoint": {
                "@type": "ContactPoint",
                "telephone": "+62-xxx-xxxx-xxxx",
                "contactType": "customer service",
                "availableLanguage": ["Indonesian", "English"]
            },
            "founder": {
                "@type": "Person",
                "name": "KortekStream Team"
            },
            "foundingDate": "2020",
            "areaServed": {
                "@type": "Country",
                "name": "Indonesia"
            },
            "serviceType": [
                "Anime Streaming",
                "Entertainment",
                "Video on Demand"
            ]
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebSite",
            "url": "{{ request.scheme }}://{{ request.get_host }}",
            "name": "KortekStream",
            "description": "Platform streaming anime terbaik di Indonesia",
            "inLanguage": "id-ID",
            "copyrightYear": "2024",
            "copyrightHolder": {
                "@type": "Organization",
                "name": "KortekStream"
            },
            "potentialAction": {
                "@type": "SearchAction",
                "target": {
                    "@type": "EntryPoint",
                    "urlTemplate": "{{ request.scheme }}://{{ request.get_host }}/search/?q={search_term_string}"
                },
                "query-input": "required name=search_term_string"
            }
        }
        </script>
        {% endblock structured_data %}

        <!-- Performance Monitoring -->
        <script>
            // Core Web Vitals monitoring
            function getCLS(onPerfEntry) {
                if ('web-vital' in window) {
                    import('web-vitals').then(({getCLS}) => {
                        getCLS(onPerfEntry);
                    });
                }
            }

            function getFID(onPerfEntry) {
                if ('web-vital' in window) {
                    import('web-vitals').then(({getFID}) => {
                        getFID(onPerfEntry);
                    });
                }
            }

            function getLCP(onPerfEntry) {
                if ('web-vital' in window) {
                    import('web-vitals').then(({getLCP}) => {
                        getLCP(onPerfEntry);
                    });
                }
            }

            // Send vitals to analytics
            function sendToAnalytics(metric) {
                // Replace with your analytics endpoint
                if (typeof gtag !== 'undefined') {
                    gtag('event', metric.name, {
                        event_category: 'Web Vitals',
                        value: Math.round(metric.name === 'CLS' ? metric.value * 1000 : metric.value),
                        event_label: metric.id,
                        non_interaction: true,
                    });
                }
            }

            getCLS(sendToAnalytics);
            getFID(sendToAnalytics);
            getLCP(sendToAnalytics);
        </script>
        
        <!-- Advanced SEO and Performance Script -->
        <script>
            // SEO Performance Optimization
            (function() {
                // Lazy load images when they come into viewport
                const lazyImages = document.querySelectorAll('img[data-src]');
                if ('IntersectionObserver' in window) {
                    const imageObserver = new IntersectionObserver((entries, observer) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                img.src = img.dataset.src;
                                img.removeAttribute('data-src');
                                observer.unobserve(img);
                            }
                        });
                    });
                    lazyImages.forEach(img => imageObserver.observe(img));
                }
                
                // Preload critical resources
                const criticalResources = [
                    '/static/css/critical.css',
                    '/static/js/performance-optimizations.js'
                ];
                
                criticalResources.forEach(resource => {
                    if (resource.endsWith('.css')) {
                        const link = document.createElement('link');
                        link.rel = 'preload';
                        link.as = 'style';
                        link.href = resource;
                        document.head.appendChild(link);
                    } else if (resource.endsWith('.js')) {
                        const link = document.createElement('link');
                        link.rel = 'preload';
                        link.as = 'script';
                        link.href = resource;
                        document.head.appendChild(link);
                    }
                });
                
                // Add loading indicators for better UX
                const loadingElements = document.querySelectorAll('[data-loading]');
                loadingElements.forEach(el => {
                    el.innerHTML = '<div class="animate-pulse bg-gray-200 dark:bg-gray-700 rounded"></div>';
                });
                
                // Track page view for SEO analytics
                if (typeof gtag !== 'undefined') {
                    gtag('config', 'GA_MEASUREMENT_ID', {
                        page_title: document.title,
                        page_location: window.location.href
                    });
                }
                
                // Service Worker for caching and offline functionality
                if ('serviceWorker' in navigator && !window.location.hostname.includes('localhost')) {
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => console.log('SW registered'))
                        .catch(error => console.log('SW registration failed'));
                }
                
                // Schema.org breadcrumb tracking
                const breadcrumbs = document.querySelectorAll('[itemtype="https://schema.org/BreadcrumbList"] [itemtype="https://schema.org/ListItem"]');
                if (breadcrumbs.length > 0) {
                    console.log(`Page has ${breadcrumbs.length} breadcrumb levels`);
                }
            })();
        </script>
        
        <!-- Page View Tracking for SEO Analytics -->
        <script>
            // Track important SEO metrics
            document.addEventListener('DOMContentLoaded', function() {
                // Track page type for SEO analytics
                const pageType = document.querySelector('meta[name="page-type"]')?.content || 'unknown';
                const category = document.querySelector('meta[name="category"]')?.content || 'general';
                
                // Performance timing for SEO
                if (window.performance && window.performance.timing) {
                    const loadTime = window.performance.timing.loadEventEnd - window.performance.timing.navigationStart;
                    if (loadTime > 0) {
                        console.log(`Page load time: ${loadTime}ms`);
                        // You can send this to your analytics service
                    }
                }
                
                // Track user engagement for SEO signals
                let startTime = Date.now();
                let maxScroll = 0;
                
                window.addEventListener('scroll', function() {
                    const scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
                    if (scrollPercent > maxScroll) {
                        maxScroll = scrollPercent;
                    }
                });
                
                // Send engagement data when user leaves
                window.addEventListener('beforeunload', function() {
                    const timeOnPage = Date.now() - startTime;
                    // Send analytics data: timeOnPage, maxScroll, pageType, etc.
                });
            });
        </script>
    </body>
</html>
