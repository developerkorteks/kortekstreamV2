{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}
    {% if episode_data.data.title %}
        {{ episode_data.data.title }} | KortekStream
    {% else %}
        Episode Detail | KortekStream
    {% endif %}
{% endblock title %}

{% block extra_css %}
    <!-- Plyr.io CSS -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    
    <style>
        .card-img-top {
            height: 250px;
            object-fit: cover;
        }
        .anime-cover {
            height: 400px;
            object-fit: cover;
        }
        .episode-card {
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        .light .episode-card:hover {
            transform: translateY(-4px);
            border-color: #FFBF00;
            box-shadow: 0 10px 20px rgba(255, 191, 0, 0.15);
        }
        .dark .episode-card:hover {
            transform: translateY(-4px);
            border-color: #E50914;
            box-shadow: 0 10px 20px rgba(229, 9, 20, 0.15);
        }
        .badge {
            @apply px-2 py-1 rounded-full text-xs font-semibold;
        }
        .light .badge-primary {
            @apply bg-gold-100 text-gold-800;
        }
        .dark .badge-primary {
            @apply bg-korteks-darkgray text-korteks-red;
        }
        .section-divider {
            @apply h-px;
        }
        .light .section-divider {
            @apply bg-gradient-to-r from-gold-400 to-transparent;
        }
        .dark .section-divider {
            @apply bg-gradient-to-r from-korteks-red to-transparent;
        }
        .server-button {
            @apply px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center;
        }
        .light .server-button {
            @apply bg-gold-50 text-gold-800 hover:bg-gold-100 border border-gold-200;
        }
        .dark .server-button {
            @apply bg-korteks-darkgray text-white hover:bg-korteks-gray border border-korteks-gray;
        }
        .light .server-button.active {
            @apply bg-gold-500 text-white border-gold-600;
        }
        .dark .server-button.active {
            @apply bg-korteks-red text-white border-korteks-red;
        }
        .download-button {
            @apply px-3 py-2 rounded-lg font-medium transition-all duration-200 flex items-center;
        }
        .light .download-button {
            @apply bg-gold-50 text-gold-800 hover:bg-gold-100 border border-gold-200;
        }
        .dark .download-button {
            @apply bg-korteks-darkgray text-white hover:bg-korteks-gray border border-korteks-gray;
        }
    </style>
{% endblock extra_css %}

{% block content %}
    <div class="min-h-screen">
        <!-- Include Navigation -->
        {% include 'components/navigation.html' %}

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            {% if error or episode_data.error %}
                <div class="bg-white dark:bg-korteks-darkgray border-l-4 border-gold-500 dark:border-korteks-red p-6 rounded-lg shadow-md">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-lg font-medium text-gray-800 dark:text-white">Something went wrong</h3>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                We're experiencing some issues. Please try again later.
                            </p>
                            {% if error_details and debug %}
                                <div class="mt-3 p-3 bg-red-50 dark:bg-red-900/20 rounded text-sm text-red-800 dark:text-red-300 font-mono">
                                    {{ error_details }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% else %}
                {% if episode_data.success and episode_data.data %}
                    <!-- Enhanced API Response Metadata -->
                    {% if debug %}
                    <div class="mb-8">
                        <div class="modern-card bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden p-8 border border-gray-200/20 dark:border-gray-700/20 hover:shadow-3xl transition-all duration-700">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-r from-rose-500 to-pink-600 dark:from-rose-600 dark:to-pink-700 rounded-2xl flex items-center justify-center mr-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-bold text-gray-800 dark:text-white">ðŸŽ¬ Episode API Status</h3>
                                        <p class="text-gray-600 dark:text-gray-400">Episode streaming data and metadata</p>
                                    </div>
                                </div>
                                <div class="bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-400 px-4 py-2 rounded-full text-sm font-semibold flex items-center">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse mr-2"></div>
                                    Debug Mode
                                </div>
                            </div>
                        
                        <!-- Debug: Full Episode Data Structure -->
                        <div class="mt-4 p-3 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray overflow-auto max-h-96">
                            <h4 class="font-medium text-gold-700 dark:text-korteks-red mb-2">Full Episode Data Structure:</h4>
                            <pre class="text-xs text-gray-800 dark:text-gray-300 whitespace-pre-wrap">{{ episode_data|pprint }}</pre>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <!-- Handle both regular and nested gomunime structure -->
                            {% if episode_data.data.message %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Message:</span>
                                <span class="ml-2">{{ episode_data.data.message }}</span>
                            </div>
                            {% elif episode_data.data.data.message %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Message:</span>
                                <span class="ml-2">{{ episode_data.data.data.message }}</span>
                            </div>
                            {% endif %}
                            
                            {% if episode_data.data.sources %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Sources:</span>
                                <span class="ml-2">{{ episode_data.data.sources|join:", " }}</span>
                            </div>
                            {% elif episode_data.data.source %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Source:</span>
                                <span class="ml-2">{{ episode_data.data.source }}</span>
                            </div>
                            {% endif %}
                            
                            {% if episode_data.data.confidence_score %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Confidence Score:</span>
                                <span class="ml-2">{{ episode_data.data.confidence_score }}</span>
                            </div>
                            {% elif episode_data.data.data.confidence_score %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Confidence Score:</span>
                                <span class="ml-2">{{ episode_data.data.data.confidence_score }}</span>
                            </div>
                            {% endif %}
                            {% if episode_data.metadata %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray md:col-span-3">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Metadata:</span>
                                <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
                                    {% if episode_data.metadata.source %}
                                    <div class="text-xs bg-gold-50 dark:bg-korteks-darkgray p-1 rounded">
                                        <span class="font-medium">Source:</span> {{ episode_data.metadata.source }}
                                    </div>
                                    {% endif %}
                                    {% if episode_data.metadata.response_time %}
                                    <div class="text-xs bg-gold-50 dark:bg-korteks-darkgray p-1 rounded">
                                        <span class="font-medium">Response Time:</span> {{ episode_data.metadata.response_time }}
                                    </div>
                                    {% endif %}
                                    {% if episode_data.metadata.cache_status %}
                                    <div class="text-xs bg-gold-50 dark:bg-korteks-darkgray p-1 rounded">
                                        <span class="font-medium">Cache Status:</span> {{ episode_data.metadata.cache_status }}
                                    </div>
                                    {% endif %}
                                    {% if episode_data.metadata.timestamp %}
                                    <div class="text-xs bg-gold-50 dark:bg-korteks-darkgray p-1 rounded">
                                        <span class="font-medium">Timestamp:</span> {{ episode_data.metadata.timestamp }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Enhanced Episode Header Section -->
                    <div class="modern-card bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden mb-12 border border-gray-200/20 dark:border-gray-700/20 hover:shadow-3xl transition-all duration-700 group">
                        <div class="p-8 relative">
                            <!-- Background animation -->
                            <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-bl from-blue-500/10 to-purple-500/10 dark:from-red-500/10 dark:to-pink-500/10 rounded-full blur-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
                            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">
                                {% if episode_data.data.data.title %}
                                    {{ episode_data.data.data.title }}
                                {% else %}
                                    {{ episode_data.data.title }}
                                {% endif %}
                            </h1>
                            
                            <!-- Anime Info Section -->
                            {% if episode_data.data.anime_info %}
                            <div class="md:flex mb-6">
                                <!-- Thumbnail -->
                                <div class="md:w-1/3 lg:w-1/4 mb-4 md:mb-0">
                                    <img src="{{ episode_data.data.anime_info.thumbnail_url }}" 
                                         alt="{{ episode_data.data.anime_info.title }}" 
                                         class="w-full rounded-lg shadow-md"
                                         onerror="this.src='https://via.placeholder.com/300x450?text=No+Image';this.onerror='';">
                                </div>
                                
                                <!-- Anime Details -->
                                <div class="md:w-2/3 lg:w-3/4 md:pl-6">
                                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3">{{ episode_data.data.anime_info.title }}</h2>
                                    
                                    <!-- Genres -->
                                    {% if episode_data.data.anime_info.genres %}
                                    <div class="mb-4">
                                        <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Genres:</h3>
                                        <div class="flex flex-wrap gap-2">
                                            {% for genre in episode_data.data.anime_info.genres %}
                                                <span class="bg-gold-100 text-gold-800 dark:bg-korteks-gray dark:text-white px-3 py-1 rounded-full text-xs">
                                                    {{ genre }}
                                                </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Synopsis -->
                                    {% if episode_data.data.anime_info.synopsis %}
                                    <div>
                                        <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Synopsis:</h3>
                                        <p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
                                            {{ episode_data.data.anime_info.synopsis }}
                                        </p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% elif episode_data.data.data.anime_info %}
                            <!-- Nested structure for gomunime -->
                            <div class="md:flex mb-6">
                                <!-- Thumbnail -->
                                <div class="md:w-1/3 lg:w-1/4 mb-4 md:mb-0">
                                    <img src="{{ episode_data.data.data.anime_info.thumbnail_url }}" 
                                         alt="{{ episode_data.data.data.anime_info.title }}" 
                                         class="w-full rounded-lg shadow-md"
                                         onerror="this.src='https://via.placeholder.com/300x450?text=No+Image';this.onerror='';">
                                </div>
                                
                                <!-- Anime Details -->
                                <div class="md:w-2/3 lg:w-3/4 md:pl-6">
                                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3">{{ episode_data.data.data.anime_info.title }}</h2>
                                    
                                    <!-- Genres -->
                                    {% if episode_data.data.data.anime_info.genres %}
                                    <div class="mb-4">
                                        <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Genres:</h3>
                                        <div class="flex flex-wrap gap-2">
                                            {% for genre in episode_data.data.data.anime_info.genres %}
                                                <span class="bg-gold-100 text-gold-800 dark:bg-korteks-gray dark:text-white px-3 py-1 rounded-full text-xs">
                                                    {{ genre }}
                                                </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Synopsis -->
                                    {% if episode_data.data.data.anime_info.synopsis %}
                                    <div>
                                        <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Synopsis:</h3>
                                        <p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
                                            {{ episode_data.data.data.anime_info.synopsis }}
                                        </p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Navigation Links -->
                            {% if episode_data.data.navigation %}
                            <div class="flex flex-wrap gap-3 mb-6">
                                {% if episode_data.data.navigation.all_episodes_url %}
                                <a href="{% url 'stream:anime_detail' %}?anime_slug={{ episode_data.data.data.anime_info.title|slugify }}&category={{ category }}" 
                                   class="bg-gold-500 hover:bg-gold-600 dark:bg-korteks-red dark:hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
                                    </svg>
                                    All Episodes
                                </a>
                                {% endif %}
                                
                                {% if episode_data.data.navigation.previous_episode_url %}
                                {% if episode_data.data.navigation.previous_episode_encoded_id and episode_data.data.navigation.previous_episode_encoded_id != '' %}
                                <a href="{% url 'stream:episode_detail' encoded_id=episode_data.data.navigation.previous_episode_encoded_id %}"
                                   class="server-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Previous Episode
                                </a>
                                {% else %}
                                <a href="{% url 'stream:episode_detail_legacy' %}?episode_url={{ episode_data.data.navigation.previous_episode_url|urlencode }}&category={{ category }}"
                                   class="server-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Previous Episode (External)
                                </a>
                                {% endif %}
                                {% endif %}
                                
                                {% if episode_data.data.navigation.next_episode_url %}
                                {% if episode_data.data.navigation.next_episode_encoded_id and episode_data.data.navigation.next_episode_encoded_id != '' %}
                                <a href="{% url 'stream:episode_detail' encoded_id=episode_data.data.navigation.next_episode_encoded_id %}"
                                   class="server-button">
                                    Next Episode
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </a>
                                {% else %}
                                <a href="{% url 'stream:episode_detail_legacy' %}?episode_url={{ episode_data.data.navigation.next_episode_url|urlencode }}&category={{ category }}"
                                   class="server-button">
                                    Next Episode (External)
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </a>
                                {% endif %}
                                {% endif %}
                            </div>
                            {% elif episode_data.data.data.navigation %}
                            <!-- Nested structure for gomunime navigation -->
                            <div class="flex flex-wrap gap-3 mb-6">
                                {% if episode_data.data.data.navigation.all_episodes_url %}
                                <a href="{% url 'stream:anime_detail' %}?anime_slug={{ episode_data.data.data.anime_info.title|slugify }}&category={{ category }}" 
                                   class="bg-gold-500 hover:bg-gold-600 dark:bg-korteks-red dark:hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
                                    </svg>
                                    All Episodes
                                </a>
                                {% endif %}
                                
                                {% if episode_data.data.data.navigation.previous_episode_url %}
                                {% if episode_data.data.data.navigation.previous_episode_encoded_id and episode_data.data.data.navigation.previous_episode_encoded_id != '' %}
                                <a href="{% url 'stream:episode_detail' encoded_id=episode_data.data.data.navigation.previous_episode_encoded_id %}"
                                   class="server-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Previous Episode
                                </a>
                                {% else %}
                                <a href="{% url 'stream:episode_detail_legacy' %}?episode_url={{ episode_data.data.data.navigation.previous_episode_url|urlencode }}&category={{ category }}"
                                   class="server-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Previous Episode (External)
                                </a>
                                {% endif %}
                                {% endif %}
                                
                                {% if episode_data.data.data.navigation.next_episode_url %}
                                {% if episode_data.data.data.navigation.next_episode_encoded_id and episode_data.data.data.navigation.next_episode_encoded_id != '' %}
                                <a href="{% url 'stream:episode_detail' encoded_id=episode_data.data.data.navigation.next_episode_encoded_id %}"
                                   class="server-button">
                                    Next Episode
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </a>
                                {% else %}
                                <a href="{% url 'stream:episode_detail_legacy' %}?episode_url={{ episode_data.data.data.navigation.next_episode_url|urlencode }}&category={{ category }}"
                                   class="server-button">
                                    Next Episode (External)
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </a>
                                {% endif %}
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Enhanced Video Player Section -->
                    {% if episode_data.data.embed_url %}
                    <div class="modern-card bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden mb-12 border border-gray-200/20 dark:border-gray-700/20 hover:shadow-3xl transition-all duration-700">
                        <div class="p-6 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-gray-700 dark:to-gray-800">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 dark:from-red-500 dark:to-pink-600 rounded-2xl flex items-center justify-center mr-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">ðŸŽ¬ Video Player</h2>
                                        <p class="text-gray-600 dark:text-gray-400">Embedded streaming player</p>
                                    </div>
                                </div>
                                <div class="bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-400 px-4 py-2 rounded-full text-sm font-semibold flex items-center">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse mr-2"></div>
                                    Live
                                </div>
                            </div>
                        </div>
                        <div class="relative" style="padding-top: 56.25%;">
                            <iframe src="{{ episode_data.data.embed_url }}"
                                    class="absolute top-0 left-0 w-full h-full rounded-b-3xl"
                                    frameborder="0"
                                    allowfullscreen>
                            </iframe>
                        </div>
                    </div>
                    {% elif episode_data.data.video_url %}
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8">
                        <div class="p-4 border-b border-gray-200 dark:border-korteks-gray">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Video Player (Direct)
                            </h2>
                        </div>
                        <div class="relative" style="padding-top: 56.25%;">
                            <video src="{{ episode_data.data.video_url }}" 
                                   class="absolute top-0 left-0 w-full h-full" 
                                   controls 
                                   preload="metadata">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    </div>
                    {% elif episode_data.data.streaming_servers and episode_data.data.streaming_servers.0.streaming_url %}
                    <!-- For gomunime format (flat structure) with enhanced player -->
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8">
                        <div class="p-4 border-b border-gray-200 dark:border-korteks-gray">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Video Player (Enhanced)
                            </h2>
                        </div>
                        
                        <!-- Server Selection Tabs -->
                        <div class="p-4 bg-gray-50 dark:bg-korteks-gray border-b border-gray-200 dark:border-korteks-darkgray">
                            <div class="flex flex-wrap gap-2" id="server-buttons-flat">
                                {% for server in episode_data.data.streaming_servers %}
                                <button 
                                    data-url="{{ server.streaming_url }}"
                                    data-server-name="{{ server.server_name }}"
                                    class="server-btn px-3 py-1 text-sm rounded-md {% if forloop.first %}bg-gold-500 text-white dark:bg-korteks-red active{% else %}bg-gray-200 text-gray-700 dark:bg-korteks-darkgray dark:text-gray-300{% endif %} hover:bg-gold-400 dark:hover:bg-red-700 transition-colors">
                                    {{ server.server_name }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Enhanced Player Container -->
                        <div class="relative" style="padding-top: 56.25%;">
                            <!-- Standard Video Player -->
                            <div id="player-wrapper-flat" class="absolute top-0 left-0 w-full h-full" style="display: none;">
                                <video id="player-flat" class="absolute top-0 left-0 w-full h-full" playsinline controls>
                                    <source id="video-source-flat" src="" type="video/mp4">
                                </video>
                            </div>
                            
                            <!-- HLS Player -->
                            <div id="hls-player-wrapper-flat" class="absolute top-0 left-0 w-full h-full" style="display: none;">
                                <video id="hls-player-flat" class="absolute top-0 left-0 w-full h-full" playsinline controls></video>
                            </div>
                            
                            <!-- Iframe Player -->
                            <div id="iframe-player-wrapper-flat" class="absolute top-0 left-0 w-full h-full">
                                <iframe id="iframe-player-flat" 
                                        src="{{ episode_data.data.streaming_servers.0.streaming_url }}" 
                                        class="absolute top-0 left-0 w-full h-full" 
                                        frameborder="0" 
                                        allowfullscreen
                                        allow="autoplay; encrypted-media; picture-in-picture">
                                </iframe>
                            </div>
                        </div>
                        
                        <!-- JavaScript for enhanced player -->
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                // Initialize variables
                                let playerFlat;
                                let hlsPlayerFlat;
                                
                                // DOM elements
                                const serverButtonsFlat = document.querySelectorAll('#server-buttons-flat .server-btn');
                                const playerWrapperFlat = document.getElementById('player-wrapper-flat');
                                const hlsPlayerWrapperFlat = document.getElementById('hls-player-wrapper-flat');
                                const iframePlayerWrapperFlat = document.getElementById('iframe-player-wrapper-flat');
                                const videoSourceFlat = document.getElementById('video-source-flat');
                                
                                // Add click event to server buttons
                                serverButtonsFlat.forEach(button => {
                                    button.addEventListener('click', function() {
                                        // Remove active class from all buttons
                                        serverButtonsFlat.forEach(btn => {
                                            btn.classList.remove('active', 'bg-gold-500', 'text-white', 'dark:bg-korteks-red');
                                            btn.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-korteks-darkgray', 'dark:text-gray-300');
                                        });
                                        
                                        // Add active class to clicked button
                                        this.classList.add('active', 'bg-gold-500', 'text-white', 'dark:bg-korteks-red');
                                        this.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-korteks-darkgray', 'dark:text-gray-300');
                                        
                                        // Set up video player with this server
                                        setupVideoPlayerFlat(this.dataset.url, this.dataset.serverName);
                                    });
                                });
                                
                                // Initialize Plyr
                                function initPlyrFlat() {
                                    if (playerFlat) {
                                        playerFlat.destroy();
                                    }
                                    
                                    playerFlat = new Plyr('#player-flat', {
                                        controls: [
                                            'play-large', 'play', 'progress', 'current-time', 'mute', 
                                            'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                                        ],
                                        seekTime: 10,
                                        keyboard: { focused: true, global: true },
                                        tooltips: { controls: true, seek: true },
                                        captions: { active: true, language: 'auto', update: true }
                                    });
                                }
                                
                                // Initialize HLS player
                                function initHlsPlayerFlat(url) {
                                    const video = document.getElementById('hls-player-flat');
                                    
                                    if (hlsPlayerFlat) {
                                        hlsPlayerFlat.destroy();
                                    }
                                    
                                    if (Hls.isSupported()) {
                                        hlsPlayerFlat = new Hls();
                                        hlsPlayerFlat.loadSource(url);
                                        hlsPlayerFlat.attachMedia(video);
                                        
                                        hlsPlayerFlat.on(Hls.Events.MANIFEST_PARSED, function() {
                                            video.play();
                                        });
                                        
                                        // Initialize Plyr for HLS video
                                        new Plyr(video, {
                                            controls: [
                                                'play-large', 'play', 'progress', 'current-time', 'mute', 
                                                'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                                            ]
                                        });
                                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                                        // Native HLS support (Safari)
                                        video.src = url;
                                        
                                        // Initialize Plyr for HLS video
                                        new Plyr(video, {
                                            controls: [
                                                'play-large', 'play', 'progress', 'current-time', 'mute', 
                                                'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                                            ]
                                        });
                                    }
                                }
                                
                                // Set up iframe player
                                function setupIframePlayerFlat(url) {
                                    const iframe = document.getElementById('iframe-player-flat');
                                    
                                    // Make sure the URL is properly formatted for embedding
                                    if (url.includes('mega.nz') && !url.includes('embed')) {
                                        url = url.replace('mega.nz/', 'mega.nz/embed/');
                                    }
                                    
                                    // Handle pixeldrain URLs
                                    if (url.includes('pixeldrain.com/api/file/')) {
                                        const fileId = url.split('/').pop();
                                        url = `https://pixeldrain.com/u/${fileId}`;
                                    }
                                    
                                    // Handle filedon.co URLs
                                    if (url.includes('filedon.co') && !url.includes('embed')) {
                                        url = url.replace('filedon.co/', 'filedon.co/embed/');
                                    }
                                    
                                    // Set the iframe source
                                    iframe.src = url;
                                }
                                
                                // Detect video type and set up appropriate player
                                function setupVideoPlayerFlat(url, serverName) {
                                    // Hide all player wrappers first
                                    playerWrapperFlat.style.display = 'none';
                                    hlsPlayerWrapperFlat.style.display = 'none';
                                    iframePlayerWrapperFlat.style.display = 'none';
                                    
                                    // Check if it's a pixeldrain direct API URL
                                    if (url.includes('pixeldrain.com/api/file/')) {
                                        const fileId = url.split('/').pop();
                                        const embedUrl = `https://pixeldrain.com/u/${fileId}`;
                                        
                                        iframePlayerWrapperFlat.style.display = 'block';
                                        setupIframePlayerFlat(embedUrl);
                                        return;
                                    }
                                    
                                    // Check if it's an iframe embed URL or needs special handling
                                    if (url.includes('embed') || 
                                        url.includes('mega.nz') || 
                                        url.includes('krakenfiles.com') || 
                                        url.includes('abysscdn.com') || 
                                        url.includes('vidhide') || 
                                        url.includes('filedon.co') ||
                                        url.includes('pixeldrain.com/u/') ||
                                        url.includes('wibufile.com/embed') ||
                                        serverName.toLowerCase().includes('iframe') ||
                                        serverName.toLowerCase().includes('pucuk')) {
                                        
                                        iframePlayerWrapperFlat.style.display = 'block';
                                        setupIframePlayerFlat(url);
                                        return;
                                    }
                                    
                                    // Check if it's an HLS stream (.m3u8)
                                    if (url.includes('.m3u8')) {
                                        hlsPlayerWrapperFlat.style.display = 'block';
                                        initHlsPlayerFlat(url);
                                        return;
                                    }
                                    
                                    // Check if it's a direct MP4 URL
                                    if (url.includes('.mp4')) {
                                        playerWrapperFlat.style.display = 'block';
                                        videoSourceFlat.src = url;
                                        const videoPlayer = document.getElementById('player-flat');
                                        videoPlayer.load();
                                        initPlyrFlat();
                                        return;
                                    }
                                    
                                    // For any other URL, try to use it with the standard player
                                    playerWrapperFlat.style.display = 'block';
                                    videoSourceFlat.src = url;
                                    const videoPlayer = document.getElementById('player-flat');
                                    videoPlayer.load();
                                    initPlyrFlat();
                                }
                                
                                // Setup the first server by default
                                if (serverButtonsFlat.length > 0) {
                                    const firstServer = serverButtonsFlat[0];
                                    setupVideoPlayerFlat(firstServer.dataset.url, firstServer.dataset.serverName);
                                }
                            });
                        </script>
                    </div>
                    
                    <!-- Other Episodes Section for Gomunime (flat structure) -->
                    {% if episode_data.data.other_episodes %}
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8">
                        <div class="p-4 border-b border-gray-200 dark:border-korteks-gray">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                                </svg>
                                Other Episodes ({{ episode_data.data.other_episodes|length }})
                            </h2>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                {% for episode in episode_data.data.other_episodes %}
                                <a href="{% url 'stream:episode_detail_legacy' %}?episode_url={{ episode.url|urlencode }}&category={{ category }}" class="block group">
                                    <div class="bg-gray-50 dark:bg-korteks-gray rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                                        <div class="relative pb-[56.25%]">
                                            <img src="{{ episode.thumbnail_url }}" 
                                                 alt="{{ episode.title }}" 
                                                 class="absolute top-0 left-0 w-full h-full object-cover group-hover:opacity-90 transition-opacity"
                                                 onerror="this.src='https://via.placeholder.com/300x169?text=No+Image';this.onerror='';">
                                        </div>
                                        <div class="p-3">
                                            <h3 class="text-sm font-medium text-gray-800 dark:text-white truncate group-hover:text-gold-600 dark:group-hover:text-korteks-red transition-colors">
                                                {{ episode.title }}
                                            </h3>
                                            {% if episode.release_date %}
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                {{ episode.release_date }}
                                            </p>
                                            {% endif %}
                                            
                                            <!-- Extract episode number from URL if possible -->
                                            {% if episode.url %}
                                                {% with url_parts=episode.url|split:"-" %}
                                                    {% if url_parts|length > 0 %}
                                                        {% with last_part=url_parts|last %}
                                                            {% if last_part|slice:":3" == "sub" %}
                                                                <!-- URL ends with "sub-indo/" -->
                                                                {% with ep_num=url_parts|slice:"-2:-1"|first %}
                                                                    <p class="text-xs font-semibold text-gold-600 dark:text-korteks-red mt-1">
                                                                        Episode: {{ ep_num }}
                                                                    </p>
                                                                {% endwith %}
                                                            {% else %}
                                                                <!-- URL might end with episode number -->
                                                                <p class="text-xs font-semibold text-gold-600 dark:text-korteks-red mt-1">
                                                                    Episode: {{ last_part|slice:":-1" }}
                                                                </p>
                                                            {% endif %}
                                                        {% endwith %}
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% elif episode_data.data.data.streaming_servers and episode_data.data.data.streaming_servers.0.streaming_url %}
                    <!-- For gomunime format (nested structure) with enhanced player -->
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8">
                        <div class="p-4 border-b border-gray-200 dark:border-korteks-gray">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Video Player (Enhanced)
                            </h2>
                        </div>
                        
                        <!-- Server Selection Tabs -->
                        <div class="p-4 bg-gray-50 dark:bg-korteks-gray border-b border-gray-200 dark:border-korteks-darkgray">
                            <div class="flex flex-wrap gap-2" id="server-buttons-nested">
                                {% for server in episode_data.data.data.streaming_servers %}
                                <button 
                                    data-url="{{ server.streaming_url }}"
                                    data-server-name="{{ server.server_name }}"
                                    class="server-btn px-3 py-1 text-sm rounded-md {% if forloop.first %}bg-gold-500 text-white dark:bg-korteks-red active{% else %}bg-gray-200 text-gray-700 dark:bg-korteks-darkgray dark:text-gray-300{% endif %} hover:bg-gold-400 dark:hover:bg-red-700 transition-colors">
                                    {{ server.server_name }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Enhanced Player Container -->
                        <div class="relative" style="padding-top: 56.25%;">
                            <!-- Standard Video Player -->
                            <div id="player-wrapper-nested" class="absolute top-0 left-0 w-full h-full" style="display: none;">
                                <video id="player-nested" class="absolute top-0 left-0 w-full h-full" playsinline controls>
                                    <source id="video-source-nested" src="" type="video/mp4">
                                </video>
                            </div>
                            
                            <!-- HLS Player -->
                            <div id="hls-player-wrapper-nested" class="absolute top-0 left-0 w-full h-full" style="display: none;">
                                <video id="hls-player-nested" class="absolute top-0 left-0 w-full h-full" playsinline controls></video>
                            </div>
                            
                            <!-- Iframe Player -->
                            <div id="iframe-player-wrapper-nested" class="absolute top-0 left-0 w-full h-full">
                                <iframe id="iframe-player-nested" 
                                        src="{{ episode_data.data.data.streaming_servers.0.streaming_url }}" 
                                        class="absolute top-0 left-0 w-full h-full" 
                                        frameborder="0" 
                                        allowfullscreen
                                        allow="autoplay; encrypted-media; picture-in-picture">
                                </iframe>
                            </div>
                        </div>
                        
                        <!-- JavaScript for enhanced player -->
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                // Initialize variables
                                let playerNested;
                                let hlsPlayerNested;
                                
                                // DOM elements
                                const serverButtonsNested = document.querySelectorAll('#server-buttons-nested .server-btn');
                                const playerWrapperNested = document.getElementById('player-wrapper-nested');
                                const hlsPlayerWrapperNested = document.getElementById('hls-player-wrapper-nested');
                                const iframePlayerWrapperNested = document.getElementById('iframe-player-wrapper-nested');
                                const videoSourceNested = document.getElementById('video-source-nested');
                                
                                // Add click event to server buttons
                                serverButtonsNested.forEach(button => {
                                    button.addEventListener('click', function() {
                                        // Remove active class from all buttons
                                        serverButtonsNested.forEach(btn => {
                                            btn.classList.remove('active', 'bg-gold-500', 'text-white', 'dark:bg-korteks-red');
                                            btn.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-korteks-darkgray', 'dark:text-gray-300');
                                        });
                                        
                                        // Add active class to clicked button
                                        this.classList.add('active', 'bg-gold-500', 'text-white', 'dark:bg-korteks-red');
                                        this.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-korteks-darkgray', 'dark:text-gray-300');
                                        
                                        // Set up video player with this server
                                        setupVideoPlayerNested(this.dataset.url, this.dataset.serverName);
                                    });
                                });
                                
                                // Initialize Plyr
                                function initPlyrNested() {
                                    if (playerNested) {
                                        playerNested.destroy();
                                    }
                                    
                                    playerNested = new Plyr('#player-nested', {
                                        controls: [
                                            'play-large', 'play', 'progress', 'current-time', 'mute', 
                                            'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                                        ],
                                        seekTime: 10,
                                        keyboard: { focused: true, global: true },
                                        tooltips: { controls: true, seek: true },
                                        captions: { active: true, language: 'auto', update: true }
                                    });
                                }
                                
                                // Initialize HLS player
                                function initHlsPlayerNested(url) {
                                    const video = document.getElementById('hls-player-nested');
                                    
                                    if (hlsPlayerNested) {
                                        hlsPlayerNested.destroy();
                                    }
                                    
                                    if (Hls.isSupported()) {
                                        hlsPlayerNested = new Hls();
                                        hlsPlayerNested.loadSource(url);
                                        hlsPlayerNested.attachMedia(video);
                                        
                                        hlsPlayerNested.on(Hls.Events.MANIFEST_PARSED, function() {
                                            video.play();
                                        });
                                        
                                        // Initialize Plyr for HLS video
                                        new Plyr(video, {
                                            controls: [
                                                'play-large', 'play', 'progress', 'current-time', 'mute', 
                                                'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                                            ]
                                        });
                                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                                        // Native HLS support (Safari)
                                        video.src = url;
                                        
                                        // Initialize Plyr for HLS video
                                        new Plyr(video, {
                                            controls: [
                                                'play-large', 'play', 'progress', 'current-time', 'mute', 
                                                'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                                            ]
                                        });
                                    }
                                }
                                
                                // Set up iframe player
                                function setupIframePlayerNested(url) {
                                    const iframe = document.getElementById('iframe-player-nested');
                                    
                                    // Make sure the URL is properly formatted for embedding
                                    if (url.includes('mega.nz') && !url.includes('embed')) {
                                        url = url.replace('mega.nz/', 'mega.nz/embed/');
                                    }
                                    
                                    // Handle pixeldrain URLs
                                    if (url.includes('pixeldrain.com/api/file/')) {
                                        const fileId = url.split('/').pop();
                                        url = `https://pixeldrain.com/u/${fileId}`;
                                    }
                                    
                                    // Handle filedon.co URLs
                                    if (url.includes('filedon.co') && !url.includes('embed')) {
                                        url = url.replace('filedon.co/', 'filedon.co/embed/');
                                    }
                                    
                                    // Set the iframe source
                                    iframe.src = url;
                                }
                                
                                // Detect video type and set up appropriate player
                                function setupVideoPlayerNested(url, serverName) {
                                    // Hide all player wrappers first
                                    playerWrapperNested.style.display = 'none';
                                    hlsPlayerWrapperNested.style.display = 'none';
                                    iframePlayerWrapperNested.style.display = 'none';
                                    
                                    // Check if it's a pixeldrain direct API URL
                                    if (url.includes('pixeldrain.com/api/file/')) {
                                        const fileId = url.split('/').pop();
                                        const embedUrl = `https://pixeldrain.com/u/${fileId}`;
                                        
                                        iframePlayerWrapperNested.style.display = 'block';
                                        setupIframePlayerNested(embedUrl);
                                        return;
                                    }
                                    
                                    // Check if it's an iframe embed URL or needs special handling
                                    if (url.includes('embed') || 
                                        url.includes('mega.nz') || 
                                        url.includes('krakenfiles.com') || 
                                        url.includes('abysscdn.com') || 
                                        url.includes('vidhide') || 
                                        url.includes('filedon.co') ||
                                        url.includes('pixeldrain.com/u/') ||
                                        url.includes('wibufile.com/embed') ||
                                        serverName.toLowerCase().includes('iframe') ||
                                        serverName.toLowerCase().includes('pucuk')) {
                                        
                                        iframePlayerWrapperNested.style.display = 'block';
                                        setupIframePlayerNested(url);
                                        return;
                                    }
                                    
                                    // Check if it's an HLS stream (.m3u8)
                                    if (url.includes('.m3u8')) {
                                        hlsPlayerWrapperNested.style.display = 'block';
                                        initHlsPlayerNested(url);
                                        return;
                                    }
                                    
                                    // Check if it's a direct MP4 URL
                                    if (url.includes('.mp4')) {
                                        playerWrapperNested.style.display = 'block';
                                        videoSourceNested.src = url;
                                        const videoPlayer = document.getElementById('player-nested');
                                        videoPlayer.load();
                                        initPlyrNested();
                                        return;
                                    }
                                    
                                    // For any other URL, try to use it with the standard player
                                    playerWrapperNested.style.display = 'block';
                                    videoSourceNested.src = url;
                                    const videoPlayer = document.getElementById('player-nested');
                                    videoPlayer.load();
                                    initPlyrNested();
                                }
                                
                                // Setup the first server by default
                                if (serverButtonsNested.length > 0) {
                                    const firstServer = serverButtonsNested[0];
                                    setupVideoPlayerNested(firstServer.dataset.url, firstServer.dataset.serverName);
                                }
                            });
                        </script>
                    </div>
                    
                    <!-- Other Episodes Section for Gomunime -->
                    {% if episode_data.data.data.other_episodes %}
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8">
                        <div class="p-4 border-b border-gray-200 dark:border-korteks-gray">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                                </svg>
                                Other Episodes ({{ episode_data.data.data.other_episodes|length }})
                            </h2>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                {% for episode in episode_data.data.data.other_episodes %}
                                <a href="{% url 'stream:episode_detail_legacy' %}?episode_url={{ episode.url|urlencode }}&category={{ category }}" class="block group">
                                    <div class="bg-gray-50 dark:bg-korteks-gray rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                                        <div class="relative pb-[56.25%]">
                                            <img src="{{ episode.thumbnail_url }}" 
                                                 alt="{{ episode.title }}" 
                                                 class="absolute top-0 left-0 w-full h-full object-cover group-hover:opacity-90 transition-opacity"
                                                 onerror="this.src='https://via.placeholder.com/300x169?text=No+Image';this.onerror='';">
                                        </div>
                                        <div class="p-3">
                                            <h3 class="text-sm font-medium text-gray-800 dark:text-white truncate group-hover:text-gold-600 dark:group-hover:text-korteks-red transition-colors">
                                                {{ episode.title }}
                                            </h3>
                                            {% if episode.release_date %}
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                {{ episode.release_date }}
                                            </p>
                                            {% endif %}
                                            
                                            <!-- Extract episode number from URL if possible -->
                                            {% if episode.url %}
                                                {% with url_parts=episode.url|split:"-" %}
                                                    {% if url_parts|length > 0 %}
                                                        {% with last_part=url_parts|last %}
                                                            {% if last_part|slice:":3" == "sub" %}
                                                                <!-- URL ends with "sub-indo/" -->
                                                                {% with ep_num=url_parts|slice:"-2:-1"|first %}
                                                                    <p class="text-xs font-semibold text-gold-600 dark:text-korteks-red mt-1">
                                                                        Episode: {{ ep_num }}
                                                                    </p>
                                                                {% endwith %}
                                                            {% else %}
                                                                <!-- URL might end with episode number -->
                                                                <p class="text-xs font-semibold text-gold-600 dark:text-korteks-red mt-1">
                                                                    Episode: {{ last_part|slice:":-1" }}
                                                                </p>
                                                            {% endif %}
                                                        {% endwith %}
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% elif episode_data.data.episode_url or episode_identifier %}
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8 p-6">
                        <div class="text-center">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">External Video Source</h2>
                            <p class="text-gray-600 dark:text-gray-300 mb-4">
                                This episode is available on an external site. Click the button below to watch it.
                            </p>
                            <a href="{{ episode_data.data.episode_url|default:episode_identifier }}" target="_blank" 
                               class="inline-flex items-center px-6 py-3 bg-gold-500 dark:bg-korteks-red text-white font-medium rounded-lg hover:bg-gold-600 dark:hover:bg-red-700 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                </svg>
                                Watch on External Site
                            </a>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Enhanced Streaming Servers Section -->
                    {% if episode_data.data.streaming_servers %}
                    <div class="modern-card bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden mb-12 p-8 border border-gray-200/20 dark:border-gray-700/20 hover:shadow-3xl transition-all duration-700">
                        <div class="flex items-center justify-between mb-8">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-600 dark:from-purple-600 dark:to-pink-700 rounded-2xl flex items-center justify-center mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">ðŸŒ Streaming Servers</h2>
                                    <p class="text-gray-600 dark:text-gray-400">Multiple server options for optimal streaming</p>
                                </div>
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 bg-purple-100 dark:bg-gray-700 px-4 py-2 rounded-full">
                                {{ episode_data.data.streaming_servers|length }} Server{{ episode_data.data.streaming_servers|length|pluralize }}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            {% for server in episode_data.data.streaming_servers %}
                            <a href="{{ server.streaming_url }}" target="_blank" class="group block">
                                <div class="modern-card bg-gradient-to-br from-purple-50 to-pink-50 dark:from-gray-700 dark:to-gray-800 p-6 rounded-2xl border border-purple-200/50 dark:border-gray-600/50 hover:shadow-xl transition-all duration-300 group-hover:scale-105 group-hover:-translate-y-1">
                                    <div class="flex items-center justify-center mb-4">
                                        <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-600 dark:from-purple-600 dark:to-pink-700 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                    </div>
                                    <h3 class="text-center font-bold text-gray-800 dark:text-white group-hover:text-purple-600 dark:group-hover:text-pink-400 transition-colors duration-300">
                                        {{ server.server_name }}
                                    </h3>
                                </div>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Enhanced Download Links Section -->
                    {% if episode_data.data.download_links %}
                    <div class="modern-card bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden mb-12 p-8 border border-gray-200/20 dark:border-gray-700/20 hover:shadow-3xl transition-all duration-700">
                        <div class="flex items-center justify-between mb-8">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-blue-600 dark:from-indigo-600 dark:to-blue-700 rounded-2xl flex items-center justify-center mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">ðŸ’¾ Download Links</h2>
                                    <p class="text-gray-600 dark:text-gray-400">Download this episode in various formats and qualities</p>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-8">
                            {% for format_type, resolutions in episode_data.data.download_links.items %}
                            <div class="modern-card bg-gradient-to-br from-indigo-50 to-blue-50 dark:from-gray-700 dark:to-gray-800 p-6 rounded-2xl border border-indigo-200/50 dark:border-gray-600/50">
                                <div class="flex items-center mb-6">
                                    <div class="w-8 h-8 bg-gradient-to-r from-indigo-500 to-blue-600 dark:from-indigo-600 dark:to-blue-700 rounded-lg flex items-center justify-center mr-3">
                                        <span class="text-white font-bold text-sm">{{ format_type|slice:":1"|upper }}</span>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-800 dark:text-white">{{ format_type }}</h3>
                                </div>
                                
                                <div class="space-y-6">
                                    {% for resolution, links in resolutions.items %}
                                    <div class="bg-white/70 dark:bg-gray-800/70 p-4 rounded-xl border border-indigo-100/50 dark:border-gray-600/50">
                                        <div class="flex items-center mb-4">
                                            <div class="w-6 h-6 bg-gradient-to-r from-indigo-400 to-blue-500 rounded-lg flex items-center justify-center mr-3">
                                                <span class="text-white font-bold text-xs">{{ resolution|slice:":1" }}</span>
                                            </div>
                                            <h4 class="text-lg font-semibold text-gray-800 dark:text-white">{{ resolution }}</h4>
                                        </div>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                            {% for link in links %}
                                            <a href="{{ link.url }}" target="_blank" class="group block">
                                                <div class="modern-card bg-gradient-to-br from-white to-gray-50 dark:from-gray-700 dark:to-gray-800 p-4 rounded-xl border border-gray-200/50 dark:border-gray-600/50 hover:shadow-lg transition-all duration-300 group-hover:scale-105 group-hover:-translate-y-1">
                                                    <div class="flex items-center justify-center">
                                                        <div class="w-8 h-8 bg-gradient-to-r from-indigo-500 to-blue-600 dark:from-indigo-600 dark:to-blue-700 rounded-lg flex items-center justify-center mr-3 group-hover:scale-110 transition-transform duration-300">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor">
                                                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                                            </svg>
                                                        </div>
                                                        <span class="font-semibold text-gray-800 dark:text-white group-hover:text-indigo-600 dark:group-hover:text-blue-400 transition-colors duration-300">{{ link.provider }}</span>
                                                    </div>
                                                </div>
                                            </a>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Enhanced Other Episodes Section -->
                    {% if episode_data.data.other_episodes %}
                    <div class="modern-card bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden mb-12 p-8 border border-gray-200/20 dark:border-gray-700/20 hover:shadow-3xl transition-all duration-700">
                        <div class="flex items-center justify-between mb-8">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-gradient-to-r from-emerald-500 to-teal-600 dark:from-emerald-600 dark:to-teal-700 rounded-2xl flex items-center justify-center mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">ðŸ“º Other Episodes</h2>
                                    <p class="text-gray-600 dark:text-gray-400">Continue watching from this series</p>
                                </div>
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 bg-emerald-100 dark:bg-gray-700 px-4 py-2 rounded-full">
                                {{ episode_data.data.other_episodes|length }} Episode{{ episode_data.data.other_episodes|length|pluralize }}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                            {% for episode in episode_data.data.other_episodes %}
                                {% if episode.encoded_id %}
                                <a href="{% url 'stream:episode_detail' encoded_id=episode.encoded_id %}" class="block">
                                    <div class="bg-gold-50 dark:bg-korteks-gray/20 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow episode-card">
                                        {% if episode.thumbnail_url %}
                                        <img src="{{ episode.thumbnail_url }}" alt="{{ episode.title }}" class="w-full h-32 object-cover">
                                        {% endif %}
                                        <div class="p-3">
                                            <h3 class="font-medium text-gray-800 dark:text-white text-sm mb-1 line-clamp-2">{{ episode.title }}</h3>
                                            {% if episode.release_date %}
                                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ episode.release_date }}</p>
                                            {% endif %}
                                            <div class="mt-2 text-gold-600 dark:text-korteks-red text-xs">
                                                Watch Episode
                                            </div>
                                        </div>
                                    </div>
                                </a>
                                {% else %}
                                {% with episode_data=episode.url|make_dict:"episode_url" %}
                                <a href="{% url 'stream:episode_detail' encoded_id=episode_data|encode_episode_id:category|default:'' %}" class="block">
                                    <div class="bg-gold-50 dark:bg-korteks-gray/20 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow episode-card">
                                        {% if episode.thumbnail_url %}
                                        <img src="{{ episode.thumbnail_url }}" alt="{{ episode.title }}" class="w-full h-32 object-cover">
                                        {% endif %}
                                        <div class="p-3">
                                            <h3 class="font-medium text-gray-800 dark:text-white text-sm mb-1 line-clamp-2">{{ episode.title }}</h3>
                                            {% if episode.release_date %}
                                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ episode.release_date }}</p>
                                            {% endif %}
                                            <div class="mt-2 text-gold-600 dark:text-korteks-red text-xs">
                                                Watch Episode
                                            </div>
                                        </div>
                                    </div>
                                </a>
                                {% endwith %}
                                {% endif %}
                            
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                {% else %}
                    <!-- No Data Available -->
                    <div class="bg-white dark:bg-korteks-darkgray border-l-4 border-gold-500 dark:border-korteks-red p-6 rounded-lg shadow-md">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-lg font-medium text-gray-800 dark:text-white">No episode data available</h3>
                                <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                    We couldn't find any information for this episode.
                                </p>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
    <!-- Plyr.js -->
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    
    <!-- HLS.js for HLS support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
{% endblock extra_js %}
