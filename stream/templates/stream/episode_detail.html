{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}
    {% if episode_data.data.title or episode_data.data.data.title %}
        {{ episode_data.data.title|default:episode_data.data.data.title }} - Nonton Episode Subtitle Indonesia | KortekStream
    {% else %}
        Episode Detail - Streaming Anime Subtitle Indonesia | KortekStream
    {% endif %}
{% endblock title %}

{% block description %}
    {% if episode_data.data.title or episode_data.data.data.title %}
        Nonton {{ episode_data.data.title|default:episode_data.data.data.title }} subtitle Indonesia gratis di KortekStream. Streaming anime dengan kualitas HD dan subtitle Indonesia terbaru.
    {% else %}
        Nonton episode anime subtitle Indonesia gratis dengan kualitas HD di KortekStream. Update episode terbaru setiap hari.
    {% endif %}
{% endblock description %}

{% block keywords %}
    {% if episode_data.data.title %}
        {{ episode_data.data.title }}, nonton {{ episode_data.data.title }}, {{ episode_data.data.title }} subtitle indonesia, episode anime, streaming episode, anime gratis, episode HD
    {% elif episode_data.data.data.title %}
        {{ episode_data.data.data.title }}, nonton {{ episode_data.data.data.title }}, {{ episode_data.data.data.title }} subtitle indonesia, episode anime, streaming episode, anime gratis, episode HD
    {% else %}
        episode anime, streaming episode, subtitle indonesia, episode gratis, nonton episode, episode HD
    {% endif %}
{% endblock keywords %}

{% block og_type %}video.episode{% endblock og_type %}

{% block og_title %}
    {% if episode_data.data.title or episode_data.data.data.title %}
        {{ episode_data.data.title|default:episode_data.data.data.title }} - Episode Subtitle Indonesia
    {% else %}
        Episode Detail - Streaming Anime Gratis
    {% endif %}
{% endblock og_title %}

{% block og_description %}
    {% if episode_data.data.title or episode_data.data.data.title %}
        Nonton {{ episode_data.data.title|default:episode_data.data.data.title }} subtitle Indonesia gratis di KortekStream.
    {% else %}
        Nonton episode anime subtitle Indonesia gratis dengan kualitas HD di KortekStream.
    {% endif %}
{% endblock og_description %}

{% block og_image %}
    {% if episode_data.data.thumb or episode_data.data.data.thumb %}
        {{ episode_data.data.thumb|default:episode_data.data.data.thumb }}
    {% else %}
        {% load static %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/og-image.jpg' %}
    {% endif %}
{% endblock og_image %}

{% block video_meta %}
    <!-- Video specific Open Graph -->
    <meta property="og:video" content="{{ request.build_absolute_uri }}" />
    <meta property="og:video:type" content="text/html" />
    <meta property="og:video:width" content="1280" />
    <meta property="og:video:height" content="720" />
    <meta property="video:duration" content="1440" />
    <meta property="video:release_date" content="{% now 'c' %}" />
    
    <!-- Episode specific meta -->
    <meta property="video:series" content="{% if episode_data.data.anime_title %}{{ episode_data.data.anime_title }}{% endif %}" />
    <meta property="video:tag" content="anime, episode, subtitle indonesia, streaming" />
    
    <!-- Article meta for episode -->
    <meta property="article:author" content="KortekStream" />
    <meta property="article:published_time" content="{% now 'c' %}" />
    <meta property="article:modified_time" content="{% now 'c' %}" />
    <meta property="article:section" content="Episode" />
    <meta property="article:tag" content="anime episode, streaming, subtitle indonesia" />
{% endblock video_meta %}

{% block extra_css %}
    <!-- Plyr.io CSS - load asynchronously -->
    <link rel="preload" href="https://cdn.plyr.io/3.7.8/plyr.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css"></noscript>
    
    <style>
        /* Critical CSS for initial render */
        .player-container {
            position: relative;
            padding-top: 56.25%;
        }
        
        /* Mobile Video Player Full Width */
        @media (max-width: 768px) {
            .player-container {
                margin-left: -1rem;
                margin-right: -1rem;
                width: calc(100% + 2rem);
            }
            
            /* Portrait mode optimization */
            @media (orientation: portrait) {
                .player-container {
                    padding-top: 75%;
                }
            }
        }
        
        /* Non-critical CSS loaded asynchronously */
        .load-styles {
            display: none;
        }
    </style>
    
    <!-- Non-critical CSS loaded asynchronously -->
    <script>
        // Inject non-critical CSS after page load
        window.addEventListener('load', function() {
            var style = document.createElement('style');
            style.textContent = `
                .card-img-top {
                    height: 250px;
                    object-fit: cover;
                }
                .anime-cover {
                    height: 400px;
                    object-fit: cover;
                }
                .episode-card {
                    transition: all 0.2s ease;
                    border: 2px solid transparent;
                }
                .light .episode-card:hover {
                    transform: translateY(-4px);
                    border-color: #FFBF00;
                    box-shadow: 0 10px 20px rgba(255, 191, 0, 0.15);
                }
                .dark .episode-card:hover {
                    transform: translateY(-4px);
                    border-color: #E50914;
                    box-shadow: 0 10px 20px rgba(229, 9, 20, 0.15);
                }
                .badge {
                    padding: 0.25rem 0.5rem;
                    border-radius: 9999px;
                    font-size: 0.75rem;
                    font-weight: 600;
                }
                .light .badge-primary {
                    background-color: #FFF4D6;
                    color: #8B6000;
                }
                .dark .badge-primary {
                    background-color: #1F1F1F;
                    color: #E50914;
                }
                .section-divider {
                    height: 1px;
                }
                .light .section-divider {
                    background-image: linear-gradient(to right, #FFBF00, transparent);
                }
                .dark .section-divider {
                    background-image: linear-gradient(to right, #E50914, transparent);
                }
                .server-button {
                    padding: 0.5rem 1rem;
                    border-radius: 0.5rem;
                    font-weight: 500;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                .light .server-button {
                    background-color: #FFF8E6;
                    color: #8B6000;
                    border: 1px solid #FFE7A3;
                }
                .light .server-button:hover {
                    background-color: #FFF4D6;
                }
                .dark .server-button {
                    background-color: #1F1F1F;
                    color: #FFFFFF;
                    border: 1px solid #2D2D2D;
                }
                .dark .server-button:hover {
                    background-color: #2D2D2D;
                }
                .light .server-button.active {
                    background-color: #FFBF00;
                    color: white;
                    border-color: #E6AC00;
                }
                .dark .server-button.active {
                    background-color: #E50914;
                    color: white;
                    border-color: #E50914;
                }
                .download-button {
                    padding: 0.5rem 0.75rem;
                    border-radius: 0.5rem;
                    font-weight: 500;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                }
                .light .download-button {
                    background-color: #FFF8E6;
                    color: #8B6000;
                    border: 1px solid #FFE7A3;
                }
                .light .download-button:hover {
                    background-color: #FFF4D6;
                }
                .dark .download-button {
                    background-color: #1F1F1F;
                    color: #FFFFFF;
                    border: 1px solid #2D2D2D;
                }
                .dark .download-button:hover {
                    background-color: #2D2D2D;
                }
                .synopsis-text {
                    transition: all 0.3s ease;
                }
                .synopsis-collapsed {
                    display: -webkit-box;
                    -webkit-line-clamp: 3;
                    -webkit-box-orient: vertical;
                    overflow: hidden;
                }
                @media (min-width: 768px) {
                    .synopsis-collapsed {
                        -webkit-line-clamp: none;
                        overflow: visible;
                    }
                }
                
                /* Mobile Video Player Full Width - Additional styles */
                @media (max-width: 768px) {
                    /* Make video player container full width on mobile */
                    .mobile-full-width {
                        margin-left: -1rem;
                        margin-right: -1rem;
                        width: calc(100% + 2rem);
                        border-radius: 0;
                    }
                    
                    /* Adjust padding for mobile */
                    .mobile-full-width .player-container {
                        margin: 0;
                        width: 100%;
                    }
                    
                    /* Landscape mode optimization */
                    @media (orientation: landscape) and (max-height: 500px) {
                        .player-container {
                            padding-top: 90vh;
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            z-index: 9999;
                            background: black;
                        }
                        
                        .player-fullscreen-mobile {
                            position: fixed !important;
                            top: 0 !important;
                            left: 0 !important;
                            right: 0 !important;
                            bottom: 0 !important;
                            width: 100vw !important;
                            height: 100vh !important;
                            z-index: 9999 !important;
                            background: black !important;
                        }
                    }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
{% endblock extra_css %}

{% block content %}
    <div class="min-h-screen">
        <!-- Include Navigation -->
        {% include 'components/navigation.html' %}
        
        <!-- Include Breadcrumbs -->
        <div class="max-w-7xl mx-auto px-3 sm:px-4 md:px-6 lg:px-8">
            {% if seo_context.breadcrumbs %}
                {% include 'components/breadcrumb.html' with breadcrumbs=seo_context.breadcrumbs %}
            {% endif %}
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-3 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-6 md:py-8">
            {% if error_occurred %}
                {% include 'components/error_display.html' %}
            {% else %}
                {% if episode_data.is_stale %}
                    <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 dark:border-yellow-500 p-4 mb-6 rounded-lg">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-400 dark:text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-800 dark:text-yellow-200">
                                    <strong>Notice:</strong> {{ episode_data.stale_message|default:"Data might be outdated due to API issues" }}
                                </p>
                            </div>
                        </div>
                    </div>
                {% endif %}
                {% if episode_data.success and episode_data.data %}
                    {% if false %}
                    <div class="mb-8">
                        <div class="modern-card bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden p-8 border border-gray-200/20 dark:border-gray-700/20 hover:shadow-3xl transition-all duration-700">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-r from-rose-500 to-pink-600 dark:from-rose-600 dark:to-pink-700 rounded-2xl flex items-center justify-center mr-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-bold text-gray-800 dark:text-white">🎬 Episode API Status</h3>
                                        <p class="text-gray-600 dark:text-gray-400">Episode streaming data and metadata</p>
                                    </div>
                                </div>
                                <div class="bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-400 px-4 py-2 rounded-full text-sm font-semibold flex items-center">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse mr-2"></div>
                                    Debug Mode
                                </div>
                            </div>
                        
                        <!-- Debug: Full Episode Data Structure -->
                        <div class="mt-4 p-3 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray overflow-auto max-h-96">
                            <h4 class="font-medium text-gold-700 dark:text-korteks-red mb-2">Full Episode Data Structure:</h4>
                            <pre class="text-xs text-gray-800 dark:text-gray-300 whitespace-pre-wrap">{{ episode_data|pprint }}</pre>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <!-- Handle both regular and nested gomunime structure -->
                            {% if episode_data.data.message or episode_data.data.data.message %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Message:</span>
                                <span class="ml-2">{{ episode_data.data.message|default:episode_data.data.data.message }}</span>
                            </div>
                            {% endif %}
                            
                            {% if episode_data.data.sources or episode_data.data.data.sources %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Sources:</span>
                                <span class="ml-2">{{ episode_data.data.sources|default:episode_data.data.data.sources|join:", " }}</span>
                            </div>
                            {% elif episode_data.data.source or episode_data.data.data.source %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Source:</span>
                                <span class="ml-2">{{ episode_data.data.source|default:episode_data.data.data.source }}</span>
                            </div>
                            {% endif %}
                            
                            {% if episode_data.data.confidence_score or episode_data.data.data.confidence_score %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Confidence Score:</span>
                                <span class="ml-2">{{ episode_data.data.confidence_score|default:episode_data.data.data.confidence_score }}</span>
                            </div>
                            {% endif %}
                            {% if episode_data.metadata %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray md:col-span-3">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Metadata:</span>
                                <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
                                    {% if episode_data.metadata.source %}
                                    <div class="text-xs bg-gold-50 dark:bg-korteks-darkgray p-1 rounded">
                                        <span class="font-medium">Source:</span> {{ episode_data.metadata.source }}
                                    </div>
                                    {% endif %}
                                    {% if episode_data.metadata.response_time %}
                                    <div class="text-xs bg-gold-50 dark:bg-korteks-darkgray p-1 rounded">
                                        <span class="font-medium">Response Time:</span> {{ episode_data.metadata.response_time }}
                                    </div>
                                    {% endif %}
                                    {% if episode_data.metadata.cache_status %}
                                    <div class="text-xs bg-gold-50 dark:bg-korteks-darkgray p-1 rounded">
                                        <span class="font-medium">Cache Status:</span> {{ episode_data.metadata.cache_status }}
                                    </div>
                                    {% endif %}
                                    {% if episode_data.metadata.timestamp %}
                                    <div class="text-xs bg-gold-50 dark:bg-korteks-darkgray p-1 rounded">
                                        <span class="font-medium">Timestamp:</span> {{ episode_data.metadata.timestamp }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Enhanced Episode Header Section -->
                    <div class="modern-card bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden mb-12 border border-gray-200/20 dark:border-gray-700/20 hover:shadow-3xl transition-all duration-700 group">
                        <div class="p-8 relative">
                            <!-- Background animation -->
                            <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-bl from-blue-500/10 to-purple-500/10 dark:from-red-500/10 dark:to-pink-500/10 rounded-full blur-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
                            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">
                                {% if episode_data.error %}
                                    Error Loading Episode
                                {% elif episode_data.data.data.title %}
                                    {{ episode_data.data.data.title }}
                                {% elif episode_data.data.title %}
                                    {{ episode_data.data.title }}
                                {% else %}
                                    Episode Details
                                {% endif %}
                            </h1>
                            
                            <!-- Error Message Section -->
                            {% if episode_data.error %}
                            <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/30 rounded-lg p-4 mb-6">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-red-800 dark:text-red-200">Error Loading Episode</h3>
                                        <div class="mt-2 text-sm text-red-700 dark:text-red-300">
                                            <p>{{ episode_data.message|default:"We're having trouble loading this episode. Please try again later." }}</p>
                                            {% if episode_data.error %}
                                            <p class="mt-2 text-xs text-red-600 dark:text-red-400">Error details: {{ episode_data.error }}</p>
                                            {% endif %}
                                        </div>
                                        <div class="mt-4">
                                            <a href="{% url 'stream:home' %}" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200 dark:text-white dark:bg-red-800 dark:hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                                Return to Home
                                            </a>
                                            <button onclick="window.location.reload()" class="ml-3 inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 dark:text-white dark:bg-gray-700 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                                Try Again
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Anime Info Section -->
                            {% if not episode_data.error %}
    {% if episode_data.data.anime_info or episode_data.data.data.anime_info %}
                            {% with anime_info=episode_data.data.anime_info|default:episode_data.data.data.anime_info %}
                            <div class="md:flex mb-6">
                                <!-- Thumbnail -->
                                <div class="md:w-1/3 lg:w-1/4 mb-4 md:mb-0">
                                    <img loading="lazy" 
                                         src="{{ anime_info.thumbnail_url }}" 
                                         alt="{{ anime_info.title }}" 
                                         class="w-full rounded-lg shadow-md"
                                         onerror="this.src='https://via.placeholder.com/300x450?text=No+Image';this.onerror='';"
                                    >
                                </div>
                                
                                <!-- Anime Details -->
                                <div class="md:w-2/3 lg:w-3/4 md:pl-6">
                                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3">{{ anime_info.title }}</h2>
                                    
                                    <!-- Genres -->
                                    {% if anime_info.genres %}
                                    <div class="mb-4">
                                        <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Genres:</h3>
                                        <div class="flex flex-wrap gap-2">
                                            {% for genre in anime_info.genres %}
                                                <span class="bg-gold-100 text-gold-800 dark:bg-korteks-gray dark:text-white px-3 py-1 rounded-full text-xs">
                                                    {{ genre }}
                                                </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Synopsis -->
                                    {% if anime_info.synopsis %}
                                    <div>
                                        <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Synopsis:</h3>
                                        <div class="synopsis-container">
                                            <p id="synopsisTextEpisode" class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed synopsis-text">
                                                {{ anime_info.synopsis }}
                                            </p>
                                            {% if anime_info.synopsis|length > 150 %}
                                            <button id="synopsisToggleEpisode" class="mt-2 text-xs text-gold-600 dark:text-korteks-red hover:underline focus:outline-none md:hidden">
                                                Show more
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endwith %}
                            {% elif episode_data.data.data.anime_info %}
                            <!-- Nested structure for gomunime -->
                            <div class="md:flex mb-6">
                                <!-- Thumbnail -->
                                <div class="md:w-1/3 lg:w-1/4 mb-4 md:mb-0">
                                    <img loading="lazy" 
                                         src="{{ episode_data.data.data.anime_info.thumbnail_url }}" 
                                         alt="{{ episode_data.data.data.anime_info.title }}" 
                                         class="w-full rounded-lg shadow-md"
                                         onerror="this.src='https://via.placeholder.com/300x450?text=No+Image';this.onerror='';">
                                </div>
                                
                                <!-- Anime Details -->
                                <div class="md:w-2/3 lg:w-3/4 md:pl-6">
                                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3">{{ episode_data.data.data.anime_info.title }}</h2>
                                    
                                    <!-- Genres -->
                                    {% if episode_data.data.data.anime_info.genres %}
                                    <div class="mb-4">
                                        <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Genres:</h3>
                                        <div class="flex flex-wrap gap-2">
                                            {% for genre in episode_data.data.data.anime_info.genres %}
                                                <span class="bg-gold-100 text-gold-800 dark:bg-korteks-gray dark:text-white px-3 py-1 rounded-full text-xs">
                                                    {{ genre }}
                                                </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Synopsis -->
                                    {% if episode_data.data.data.anime_info.synopsis %}
                                    <div>
                                        <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Synopsis:</h3>
                                        <div class="synopsis-container">
                                            <p id="synopsisTextEpisodeNested" class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed synopsis-text">
                                                {{ episode_data.data.data.anime_info.synopsis }}
                                            </p>
                                            {% if episode_data.data.data.anime_info.synopsis|length > 150 %}
                                            <button id="synopsisToggleEpisodeNested" class="mt-2 text-xs text-gold-600 dark:text-korteks-red hover:underline focus:outline-none md:hidden">
                                                Show more
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Navigation Links -->
                            {% if episode_data.data.navigation or episode_data.data.data.navigation %}
                            {% with navigation=episode_data.data.navigation|default:episode_data.data.data.navigation %}
                            <div class="flex flex-wrap gap-3 mb-6">
                                {% if navigation.all_episodes_url %}
                                <a href="{{ navigation.all_episodes_url }}" 
                                   class="bg-gold-500 hover:bg-gold-600 dark:bg-korteks-red dark:hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
                                    </svg>
                                    All Episodes
                                </a>
                                {% endif %}
                                
                                {% if navigation.previous_episode_url %}
                                {% if navigation.previous_episode_encoded_id and navigation.previous_episode_encoded_id != '' %}
                                <a href="{% url 'stream:episode_detail' encoded_id=navigation.previous_episode_encoded_id %}"
                                   class="bg-gray-200 hover:bg-gray-300 dark:bg-korteks-gray dark:hover:bg-gray-700 text-gray-800 dark:text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Previous Episode
                                </a>
                                {% else %}
                                <a href="{% url 'stream:episode_detail_legacy' %}?episode_url={{ navigation.previous_episode_url|urlencode }}&category={{ category }}"
                                   class="bg-gray-200 hover:bg-gray-300 dark:bg-korteks-gray dark:hover:bg-gray-700 text-gray-800 dark:text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Previous Episode
                                </a>
                                {% endif %}
                                {% endif %}
                                
                                {% if navigation.next_episode_url %}
                                {% if navigation.next_episode_encoded_id and navigation.next_episode_encoded_id != '' %}
                                <a href="{% url 'stream:episode_detail' encoded_id=navigation.next_episode_encoded_id %}"
                                   class="bg-gray-200 hover:bg-gray-300 dark:bg-korteks-gray dark:hover:bg-gray-700 text-gray-800 dark:text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
                                    Next Episode
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </a>
                                {% else %}
                                <a href="{% url 'stream:episode_detail_legacy' %}?episode_url={{ navigation.next_episode_url|urlencode }}&category={{ category }}"
                                   class="bg-gray-200 hover:bg-gray-300 dark:bg-korteks-gray dark:hover:bg-gray-700 text-gray-800 dark:text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
                                    Next Episode
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </a>
                                {% endif %}
                                {% endif %}
                            </div>
                            {% endwith %}
                            {% endif %}
                        {% endif %}
                        </div>
                    </div>
                    
                    <!-- Enhanced Video Player Section -->
                    {% if not episode_data.error %}
    {% if episode_data.data.embed_url %}
                    <div class="modern-card bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl md:rounded-3xl shadow-2xl overflow-hidden mb-8 sm:mb-12 border border-gray-200/20 dark:border-gray-700/20 hover:shadow-3xl transition-all duration-700">
                        <div class="p-4 sm:p-6 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-gray-700 dark:to-gray-800">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 dark:from-red-500 dark:to-pink-600 rounded-2xl flex items-center justify-center mr-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">🎬 Video Player</h2>
                                        <p class="text-gray-600 dark:text-gray-400">Embedded streaming player</p>
                                    </div>
                                </div>
                                <div class="bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-400 px-4 py-2 rounded-full text-sm font-semibold flex items-center">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse mr-2"></div>
                                    Live
                                </div>
                            </div>
                        </div>
                        <div class="relative" style="padding-top: 56.25%;">
                            <iframe src="{{ episode_data.data.embed_url }}"
                                    class="absolute top-0 left-0 w-full h-full rounded-b-3xl"
                                    frameborder="0"
                                    allowfullscreen>
                            </iframe>
                        </div>
                    </div>
                    {% elif episode_data.data.video_url %}
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8">
                        <div class="p-4 border-b border-gray-200 dark:border-korteks-gray">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Video Player (Direct)
                            </h2>
                        </div>
                        <div class="relative" style="padding-top: 56.25%;">
                            <video src="{{ episode_data.data.video_url }}" 
                                   class="absolute top-0 left-0 w-full h-full" 
                                   controls 
                                   preload="metadata">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    </div>
                    {% elif episode_data.data.streaming_servers and episode_data.data.streaming_servers.0.streaming_url or episode_data.data.data.streaming_servers and episode_data.data.data.streaming_servers.0.streaming_url %}
                    <!-- For gomunime format (flat structure) with enhanced player -->
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8 mobile-full-width">
                        <div class="p-4 border-b border-gray-200 dark:border-korteks-gray">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Video Player (Enhanced)
                            </h2>
                        </div>
                        
                        <!-- Server Selection Dropdown -->
                        <div class="p-4 bg-gray-50 dark:bg-korteks-gray border-b border-gray-200 dark:border-korteks-darkgray">
                            <div class="flex items-center gap-3">
                                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Server:</label>
                                <div class="relative">
                                    <select id="server-dropdown-flat" class="appearance-none bg-white dark:bg-korteks-darkgray border border-gray-300 dark:border-korteks-gray rounded-lg px-4 py-2 pr-8 text-sm text-gray-700 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-gold-500 dark:focus:ring-korteks-red focus:border-transparent">
                                        {% with streaming_servers=episode_data.data.streaming_servers|default:episode_data.data.data.streaming_servers %}
                                        {% for server in streaming_servers %}
                                        <option value="{{ server.streaming_url }}" data-server-name="{{ server.server_name }}" {% if forloop.first %}selected{% endif %}>
                                            {{ server.server_name }}
                                        </option>
                                        {% endfor %}
                                        {% endwith %}
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Player Container -->
                        <div class="player-container relative" style="padding-top: 56.25%;">
                            <!-- Standard Video Player -->
                            <div id="player-wrapper-flat" class="absolute top-0 left-0 w-full h-full" style="display: none;">
                                <video id="player-flat" class="absolute top-0 left-0 w-full h-full" playsinline controls>
                                    <source id="video-source-flat" src="" type="video/mp4">
                                </video>
                            </div>
                            
                            <!-- HLS Player -->
                            <div id="hls-player-wrapper-flat" class="absolute top-0 left-0 w-full h-full" style="display: none;">
                                <video id="hls-player-flat" class="absolute top-0 left-0 w-full h-full" playsinline controls></video>
                            </div>
                            
                            <!-- Iframe Player -->
                            <div id="iframe-player-wrapper-flat" class="absolute top-0 left-0 w-full h-full">
                                <iframe id="iframe-player-flat" 
                                        src="{{ episode_data.data.streaming_servers.0.streaming_url|default:episode_data.data.data.streaming_servers.0.streaming_url }}" 
                                        class="absolute top-0 left-0 w-full h-full" 
                                        frameborder="0" 
                                        allowfullscreen
                                        allow="autoplay; encrypted-media; picture-in-picture">
                                </iframe>
                            </div>
                        </div>
                        
                        <!-- JavaScript for enhanced player -->
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                // Initialize variables
                                let playerFlat;
                                let hlsPlayerFlat;
                                
                                // DOM elements
                                const serverDropdownFlat = document.getElementById('server-dropdown-flat');
                                const playerWrapperFlat = document.getElementById('player-wrapper-flat');
                                const hlsPlayerWrapperFlat = document.getElementById('hls-player-wrapper-flat');
                                const iframePlayerWrapperFlat = document.getElementById('iframe-player-wrapper-flat');
                                const videoSourceFlat = document.getElementById('video-source-flat');
                                
                                // Add change event to server dropdown
                                if (serverDropdownFlat) {
                                    serverDropdownFlat.addEventListener('change', function() {
                                        const selectedOption = this.options[this.selectedIndex];
                                        const url = selectedOption.value;
                                        const serverName = selectedOption.dataset.serverName;
                                        
                                        // Set up video player with selected server
                                        setupVideoPlayerFlat(url, serverName);
                                    });
                                    
                                    // Initialize with first server
                                    if (serverDropdownFlat.options.length > 0) {
                                        const firstOption = serverDropdownFlat.options[0];
                                        setupVideoPlayerFlat(firstOption.value, firstOption.dataset.serverName);
                                    }
                                }
                                
                                // Initialize Plyr
                                function initPlyrFlat() {
                                    if (playerFlat) {
                                        playerFlat.destroy();
                                    }
                                    
                                    playerFlat = new Plyr('#player-flat', {
                                        controls: [
                                            'play-large', 'play', 'progress', 'current-time', 'mute', 
                                            'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                                        ],
                                        seekTime: 10,
                                        keyboard: { focused: true, global: true },
                                        tooltips: { controls: true, seek: true },
                                        captions: { active: true, language: 'auto', update: true }
                                    });
                                }
                                
                                // Initialize HLS player
                                function initHlsPlayerFlat(url) {
                                    const video = document.getElementById('hls-player-flat');
                                    
                                    if (hlsPlayerFlat) {
                                        hlsPlayerFlat.destroy();
                                    }
                                    
                                    if (Hls.isSupported()) {
                                        hlsPlayerFlat = new Hls();
                                        hlsPlayerFlat.loadSource(url);
                                        hlsPlayerFlat.attachMedia(video);
                                        
                                        hlsPlayerFlat.on(Hls.Events.MANIFEST_PARSED, function() {
                                            video.play();
                                        });
                                        
                                        // Initialize Plyr for HLS video
                                        new Plyr(video, {
                                            controls: [
                                                'play-large', 'play', 'progress', 'current-time', 'mute', 
                                                'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                                            ]
                                        });
                                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                                        // Native HLS support (Safari)
                                        video.src = url;
                                        
                                        // Initialize Plyr for HLS video
                                        new Plyr(video, {
                                            controls: [
                                                'play-large', 'play', 'progress', 'current-time', 'mute', 
                                                'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                                            ]
                                        });
                                    }
                                }
                                
                                // Set up iframe player
                                function setupIframePlayerFlat(url) {
                                    const iframe = document.getElementById('iframe-player-flat');
                                    
                                    // Make sure the URL is properly formatted for embedding
                                    if (url.includes('mega.nz') && !url.includes('embed')) {
                                        url = url.replace('mega.nz/', 'mega.nz/embed/');
                                    }
                                    
                                    // Handle pixeldrain URLs
                                    if (url.includes('pixeldrain.com/api/file/')) {
                                        const fileId = url.split('/').pop();
                                        url = `https://pixeldrain.com/u/${fileId}`;
                                    }
                                    
                                    // Handle filedon.co URLs
                                    if (url.includes('filedon.co') && !url.includes('embed')) {
                                        url = url.replace('filedon.co/', 'filedon.co/embed/');
                                    }
                                    
                                    // Set the iframe source
                                    iframe.src = url;
                                }
                                
                                // Detect video type and set up appropriate player
                                function setupVideoPlayerFlat(url, serverName) {
                                    // Hide all player wrappers first
                                    playerWrapperFlat.style.display = 'none';
                                    hlsPlayerWrapperFlat.style.display = 'none';
                                    iframePlayerWrapperFlat.style.display = 'none';
                                    
                                    // Check if it's a pixeldrain direct API URL
                                    if (url.includes('pixeldrain.com/api/file/')) {
                                        const fileId = url.split('/').pop();
                                        const embedUrl = `https://pixeldrain.com/u/${fileId}`;
                                        
                                        iframePlayerWrapperFlat.style.display = 'block';
                                        setupIframePlayerFlat(embedUrl);
                                        return;
                                    }
                                    
                                    // Check if it's an iframe embed URL or needs special handling
                                    if (url.includes('embed') || 
                                        url.includes('mega.nz') || 
                                        url.includes('krakenfiles.com') || 
                                        url.includes('abysscdn.com') || 
                                        url.includes('vidhide') || 
                                        url.includes('filedon.co') ||
                                        url.includes('pixeldrain.com/u/') ||
                                        url.includes('wibufile.com/embed') ||
                                        serverName.toLowerCase().includes('iframe') ||
                                        serverName.toLowerCase().includes('pucuk')) {
                                        
                                        iframePlayerWrapperFlat.style.display = 'block';
                                        setupIframePlayerFlat(url);
                                        return;
                                    }
                                    
                                    // Check if it's an HLS stream (.m3u8)
                                    if (url.includes('.m3u8')) {
                                        hlsPlayerWrapperFlat.style.display = 'block';
                                        initHlsPlayerFlat(url);
                                        return;
                                    }
                                    
                                    // Check if it's a direct MP4 URL
                                    if (url.includes('.mp4')) {
                                        playerWrapperFlat.style.display = 'block';
                                        videoSourceFlat.src = url;
                                        const videoPlayer = document.getElementById('player-flat');
                                        videoPlayer.load();
                                        initPlyrFlat();
                                        return;
                                    }
                                    
                                    // For any other URL, try to use it with the standard player
                                    playerWrapperFlat.style.display = 'block';
                                    videoSourceFlat.src = url;
                                    const videoPlayer = document.getElementById('player-flat');
                                    videoPlayer.load();
                                    initPlyrFlat();
                                }
                                
                                // Setup the first server by default
                                if (serverButtonsFlat.length > 0) {
                                    const firstServer = serverButtonsFlat[0];
                                    setupVideoPlayerFlat(firstServer.dataset.url, firstServer.dataset.serverName);
                                }
                            });
                        </script>
                    </div>
                    
                    <!-- Other Episodes Section for Gomunime (flat structure) -->
                    {% if episode_data.data.other_episodes %}
                    <div class="modern-card bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl md:rounded-3xl shadow-2xl overflow-hidden mb-8 sm:mb-12 p-4 sm:p-6 md:p-8 border border-gray-200/20 dark:border-gray-700/20 hover:shadow-3xl transition-all duration-700">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 sm:mb-8">
                            <div class="flex items-center mb-4 sm:mb-0">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-emerald-500 to-teal-600 dark:from-emerald-600 dark:to-teal-700 rounded-xl sm:rounded-2xl flex items-center justify-center mr-3 sm:mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 md:h-7 md:w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 dark:text-white"> Other Episodes</h2>
                                    <p class="text-sm sm:text-base text-gray-600 dark:text-gray-400">Continue watching from this series</p>
                                </div>
                            </div>
                            <div class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 bg-emerald-100 dark:bg-gray-700 px-3 sm:px-4 py-2 rounded-full w-fit">
                                {{ episode_data.data.other_episodes|length }} Episode{{ episode_data.data.other_episodes|length|pluralize }}
                            </div>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 sm:gap-4 md:gap-6">
                                {% for episode in episode_data.data.other_episodes %}
                                <a href="{% url 'stream:episode_detail_legacy' %}?episode_url={{ episode.url|urlencode }}&category={{ category }}" class="block group">
                                    <div class="bg-gray-50 dark:bg-korteks-gray rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                                        <div class="relative pb-[56.25%]">
                                            <img loading="lazy" src="{{ episode.thumbnail_url }}" 
                                                 alt="{{ episode.title }}" 
                                                 class="absolute top-0 left-0 w-full h-full object-cover group-hover:opacity-90 transition-opacity"
                                                 onerror="this.src='https://via.placeholder.com/300x169?text=No+Image';this.onerror='';">
                                        </div>
                                        <div class="p-3">
                                            <h3 class="text-sm font-medium text-gray-800 dark:text-white truncate group-hover:text-gold-600 dark:group-hover:text-korteks-red transition-colors">
                                                {{ episode.title }}
                                            </h3>
                                            {% if episode.release_date %}
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                {{ episode.release_date }}
                                            </p>
                                            {% endif %}
                                            
                                            <!-- Extract episode number from URL if possible -->
                                            {% if episode.url %}
                                                {% with url_parts=episode.url|split:"-" %}
                                                    {% if url_parts|length > 0 %}
                                                        {% with last_part=url_parts|last %}
                                                            {% if last_part|slice:":3" == "sub" %}
                                                                <!-- URL ends with "sub-indo/" -->
                                                                {% with ep_num=url_parts|slice:"-2:-1"|first %}
                                                                    <p class="text-xs font-semibold text-gold-600 dark:text-korteks-red mt-1">
                                                                        Episode: {{ ep_num }}
                                                                    </p>
                                                                {% endwith %}
                                                            {% else %}
                                                                <!-- URL might end with episode number -->
                                                                <p class="text-xs font-semibold text-gold-600 dark:text-korteks-red mt-1">
                                                                    Episode: {{ last_part|slice:":-1" }}
                                                                </p>
                                                            {% endif %}
                                                        {% endwith %}
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% elif episode_data.data.data.streaming_servers and episode_data.data.data.streaming_servers.0.streaming_url %}
                    <!-- For gomunime format (nested structure) with enhanced player -->
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8 mobile-full-width">
                        <div class="p-4 border-b border-gray-200 dark:border-korteks-gray">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Video Player (Enhanced)
                            </h2>
                        </div>
                        
                        <!-- Server Selection Dropdown -->
                        <div class="p-4 bg-gray-50 dark:bg-korteks-gray border-b border-gray-200 dark:border-korteks-darkgray">
                            <div class="flex items-center gap-3">
                                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Server:</label>
                                <div class="relative">
                                    <select id="server-dropdown-nested" class="appearance-none bg-white dark:bg-korteks-darkgray border border-gray-300 dark:border-korteks-gray rounded-lg px-4 py-2 pr-8 text-sm text-gray-700 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-gold-500 dark:focus:ring-korteks-red focus:border-transparent">
                                        {% for server in episode_data.data.data.streaming_servers %}
                                        <option value="{{ server.streaming_url }}" data-server-name="{{ server.server_name }}" {% if forloop.first %}selected{% endif %}>
                                            {{ server.server_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Player Container -->
                        <div class="relative" style="padding-top: 56.25%;">
                            <!-- Standard Video Player -->
                            <div id="player-wrapper-nested" class="absolute top-0 left-0 w-full h-full" style="display: none;">
                                <video id="player-nested" class="absolute top-0 left-0 w-full h-full" playsinline controls>
                                    <source id="video-source-nested" src="" type="video/mp4">
                                </video>
                            </div>
                            
                            <!-- HLS Player -->
                            <div id="hls-player-wrapper-nested" class="absolute top-0 left-0 w-full h-full" style="display: none;">
                                <video id="hls-player-nested" class="absolute top-0 left-0 w-full h-full" playsinline controls></video>
                            </div>
                            
                            <!-- Iframe Player -->
                            <div id="iframe-player-wrapper-nested" class="absolute top-0 left-0 w-full h-full">
                                <iframe id="iframe-player-nested" 
                                        src="{{ episode_data.data.data.streaming_servers.0.streaming_url }}" 
                                        class="absolute top-0 left-0 w-full h-full" 
                                        frameborder="0" 
                                        allowfullscreen
                                        allow="autoplay; encrypted-media; picture-in-picture">
                                </iframe>
                            </div>
                        </div>
                        
                        <!-- JavaScript for enhanced player -->
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                // Initialize variables
                                let playerNested;
                                let hlsPlayerNested;
                                
                                // DOM elements
                                const serverDropdownNested = document.getElementById('server-dropdown-nested');
                                const playerWrapperNested = document.getElementById('player-wrapper-nested');
                                const hlsPlayerWrapperNested = document.getElementById('hls-player-wrapper-nested');
                                const iframePlayerWrapperNested = document.getElementById('iframe-player-wrapper-nested');
                                const videoSourceNested = document.getElementById('video-source-nested');
                                
                                // Add change event to server dropdown
                                if (serverDropdownNested) {
                                    serverDropdownNested.addEventListener('change', function() {
                                        const selectedOption = this.options[this.selectedIndex];
                                        const url = selectedOption.value;
                                        const serverName = selectedOption.dataset.serverName;
                                        
                                        // Set up video player with selected server
                                        setupVideoPlayerNested(url, serverName);
                                    });
                                    
                                    // Initialize with first server
                                    if (serverDropdownNested.options.length > 0) {
                                        const firstOption = serverDropdownNested.options[0];
                                        setupVideoPlayerNested(firstOption.value, firstOption.dataset.serverName);
                                    }
                                }
                                
                                // Initialize Plyr
                                function initPlyrNested() {
                                    if (playerNested) {
                                        playerNested.destroy();
                                    }
                                    
                                    playerNested = new Plyr('#player-nested', {
                                        controls: [
                                            'play-large', 'play', 'progress', 'current-time', 'mute', 
                                            'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                                        ],
                                        seekTime: 10,
                                        keyboard: { focused: true, global: true },
                                        tooltips: { controls: true, seek: true },
                                        captions: { active: true, language: 'auto', update: true }
                                    });
                                }
                                
                                // Initialize HLS player
                                function initHlsPlayerNested(url) {
                                    const video = document.getElementById('hls-player-nested');
                                    
                                    if (hlsPlayerNested) {
                                        hlsPlayerNested.destroy();
                                    }
                                    
                                    if (Hls.isSupported()) {
                                        hlsPlayerNested = new Hls();
                                        hlsPlayerNested.loadSource(url);
                                        hlsPlayerNested.attachMedia(video);
                                        
                                        hlsPlayerNested.on(Hls.Events.MANIFEST_PARSED, function() {
                                            video.play();
                                        });
                                        
                                        // Initialize Plyr for HLS video
                                        new Plyr(video, {
                                            controls: [
                                                'play-large', 'play', 'progress', 'current-time', 'mute', 
                                                'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                                            ]
                                        });
                                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                                        // Native HLS support (Safari)
                                        video.src = url;
                                        
                                        // Initialize Plyr for HLS video
                                        new Plyr(video, {
                                            controls: [
                                                'play-large', 'play', 'progress', 'current-time', 'mute', 
                                                'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                                            ]
                                        });
                                    }
                                }
                                
                                // Set up iframe player
                                function setupIframePlayerNested(url) {
                                    const iframe = document.getElementById('iframe-player-nested');
                                    
                                    // Make sure the URL is properly formatted for embedding
                                    if (url.includes('mega.nz') && !url.includes('embed')) {
                                        url = url.replace('mega.nz/', 'mega.nz/embed/');
                                    }
                                    
                                    // Handle pixeldrain URLs
                                    if (url.includes('pixeldrain.com/api/file/')) {
                                        const fileId = url.split('/').pop();
                                        url = `https://pixeldrain.com/u/${fileId}`;
                                    }
                                    
                                    // Handle filedon.co URLs
                                    if (url.includes('filedon.co') && !url.includes('embed')) {
                                        url = url.replace('filedon.co/', 'filedon.co/embed/');
                                    }
                                    
                                    // Set the iframe source
                                    iframe.src = url;
                                }
                                
                                // Detect video type and set up appropriate player
                                function setupVideoPlayerNested(url, serverName) {
                                    // Hide all player wrappers first
                                    playerWrapperNested.style.display = 'none';
                                    hlsPlayerWrapperNested.style.display = 'none';
                                    iframePlayerWrapperNested.style.display = 'none';
                                    
                                    // Check if it's a pixeldrain direct API URL
                                    if (url.includes('pixeldrain.com/api/file/')) {
                                        const fileId = url.split('/').pop();
                                        const embedUrl = `https://pixeldrain.com/u/${fileId}`;
                                        
                                        iframePlayerWrapperNested.style.display = 'block';
                                        setupIframePlayerNested(embedUrl);
                                        return;
                                    }
                                    
                                    // Check if it's an iframe embed URL or needs special handling
                                    if (url.includes('embed') || 
                                        url.includes('mega.nz') || 
                                        url.includes('krakenfiles.com') || 
                                        url.includes('abysscdn.com') || 
                                        url.includes('vidhide') || 
                                        url.includes('filedon.co') ||
                                        url.includes('pixeldrain.com/u/') ||
                                        url.includes('wibufile.com/embed') ||
                                        serverName.toLowerCase().includes('iframe') ||
                                        serverName.toLowerCase().includes('pucuk')) {
                                        
                                        iframePlayerWrapperNested.style.display = 'block';
                                        setupIframePlayerNested(url);
                                        return;
                                    }
                                    
                                    // Check if it's an HLS stream (.m3u8)
                                    if (url.includes('.m3u8')) {
                                        hlsPlayerWrapperNested.style.display = 'block';
                                        initHlsPlayerNested(url);
                                        return;
                                    }
                                    
                                    // Check if it's a direct MP4 URL
                                    if (url.includes('.mp4')) {
                                        playerWrapperNested.style.display = 'block';
                                        videoSourceNested.src = url;
                                        const videoPlayer = document.getElementById('player-nested');
                                        videoPlayer.load();
                                        initPlyrNested();
                                        return;
                                    }
                                    
                                    // For any other URL, try to use it with the standard player
                                    playerWrapperNested.style.display = 'block';
                                    videoSourceNested.src = url;
                                    const videoPlayer = document.getElementById('player-nested');
                                    videoPlayer.load();
                                    initPlyrNested();
                                }
                                
                                // Note: First server initialization is now handled in the dropdown change event listener
                            });
                        </script>
                    </div>
                    
                    <!-- Other Episodes Section for Gomunime -->
                    {% if episode_data.data.data.other_episodes %}
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8">
                        <div class="p-4 border-b border-gray-200 dark:border-korteks-gray">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                                </svg>
                                Other Episodes ({{ episode_data.data.data.other_episodes|length }})
                            </h2>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                {% for episode in episode_data.data.data.other_episodes %}
                                <a href="{% url 'stream:episode_detail_legacy' %}?episode_url={{ episode.url|urlencode }}&category={{ category }}" class="block group">
                                    <div class="bg-gray-50 dark:bg-korteks-gray rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                                        <div class="relative pb-[56.25%]">
                                            <img loading="lazy" src="{{ episode.thumbnail_url }}" 
                                                 alt="{{ episode.title }}" 
                                                 class="absolute top-0 left-0 w-full h-full object-cover group-hover:opacity-90 transition-opacity"
                                                 onerror="this.src='https://via.placeholder.com/300x169?text=No+Image';this.onerror='';">
                                        </div>
                                        <div class="p-3">
                                            <h3 class="text-sm font-medium text-gray-800 dark:text-white truncate group-hover:text-gold-600 dark:group-hover:text-korteks-red transition-colors">
                                                {{ episode.title }}
                                            </h3>
                                            {% if episode.release_date %}
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                {{ episode.release_date }}
                                            </p>
                                            {% endif %}
                                            
                                            <!-- Extract episode number from URL if possible -->
                                            {% if episode.url %}
                                                {% with url_parts=episode.url|split:"-" %}
                                                    {% if url_parts|length > 0 %}
                                                        {% with last_part=url_parts|last %}
                                                            {% if last_part|slice:":3" == "sub" %}
                                                                <!-- URL ends with "sub-indo/" -->
                                                                {% with ep_num=url_parts|slice:"-2:-1"|first %}
                                                                    <p class="text-xs font-semibold text-gold-600 dark:text-korteks-red mt-1">
                                                                        Episode: {{ ep_num }}
                                                                    </p>
                                                                {% endwith %}
                                                            {% else %}
                                                                <!-- URL might end with episode number -->
                                                                <p class="text-xs font-semibold text-gold-600 dark:text-korteks-red mt-1">
                                                                    Episode: {{ last_part|slice:":-1" }}
                                                                </p>
                                                            {% endif %}
                                                        {% endwith %}
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% elif episode_data.data.episode_url or episode_data.data.data.episode_url or episode_identifier %}
                    <div class="modern-card bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl md:rounded-3xl shadow-2xl overflow-hidden mb-8 sm:mb-12 border border-gray-200/20 dark:border-gray-700/20 hover:shadow-3xl transition-all duration-700">
                        <div class="p-4 sm:p-6 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-gray-700 dark:to-gray-800">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 dark:from-red-500 dark:to-pink-600 rounded-2xl flex items-center justify-center mr-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">🎬 External Video Source</h2>
                                        <p class="text-gray-600 dark:text-gray-400">Watch on the original streaming site</p>
                                    </div>
                                </div>
                                <div class="bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-400 px-4 py-2 rounded-full text-sm font-semibold flex items-center">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse mr-2"></div>
                                    Available
                                </div>
                            </div>
                        </div>
                        <div class="p-8 text-center">
                            <p class="text-gray-600 dark:text-gray-300 mb-6 text-lg">
                                This episode is available on an external site. Click the button below to watch it.
                            </p>
                            <a href="{{ episode_data.data.episode_url|default:episode_data.data.data.episode_url|default:episode_identifier }}" target="_blank" 
                               class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-600 dark:from-red-500 dark:to-pink-600 text-white font-medium rounded-xl hover:from-blue-600 hover:to-purple-700 dark:hover:from-red-600 dark:hover:to-pink-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                </svg>
                                Watch on External Site
                            </a>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    <!-- Enhanced Streaming Servers Section with Dropdown -->
                    {% if not episode_data.error %}
                        {% if episode_data.data.streaming_servers or episode_data.data.data.streaming_servers %}
                    <div class="modern-card bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl md:rounded-3xl shadow-2xl overflow-hidden mb-8 sm:mb-12 p-4 sm:p-6 md:p-8 border border-gray-200/20 dark:border-gray-700/20 hover:shadow-3xl transition-all duration-700">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 sm:mb-8">
                            <div class="flex items-center mb-4 sm:mb-0">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-purple-500 to-pink-600 dark:from-purple-600 dark:to-pink-700 rounded-xl sm:rounded-2xl flex items-center justify-center mr-3 sm:mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 md:h-7 md:w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 dark:text-white">🌐 Streaming Servers</h2>
                                    <p class="text-sm sm:text-base text-gray-600 dark:text-gray-400">Multiple server options for optimal streaming</p>
                                </div>
                            </div>
                            <button id="streamingToggle" class="flex items-center text-xs sm:text-sm text-gray-500 dark:text-gray-400 bg-purple-100 dark:bg-gray-700 px-3 sm:px-4 py-2 rounded-full hover:bg-purple-200 dark:hover:bg-gray-600 transition-colors duration-300">
                                <span class="mr-2">{{ episode_data.data.streaming_servers|default:episode_data.data.data.streaming_servers|length }} Server{{ episode_data.data.streaming_servers|default:episode_data.data.data.streaming_servers|length|pluralize }}</span>
                                <svg id="streamingChevron" class="w-4 h-4 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>

                        <div id="streamingContent" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-4 md:gap-6 hidden">
                            {% with streaming_servers=episode_data.data.streaming_servers|default:episode_data.data.data.streaming_servers %}
                            {% for server in streaming_servers %}
                            <a href="{{ server.streaming_url }}" target="_blank" class="group block">
                                <div class="modern-card bg-gradient-to-br from-purple-50 to-pink-50 dark:from-gray-700 dark:to-gray-800 p-6 rounded-2xl border border-purple-200/50 dark:border-gray-600/50 hover:shadow-xl transition-all duration-300 group-hover:scale-105 group-hover:-translate-y-1">
                                    <div class="flex items-center justify-center mb-4">
                                        <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-600 dark:from-purple-600 dark:to-pink-700 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                    </div>
                                    <h3 class="text-center font-bold text-gray-800 dark:text-white group-hover:text-purple-600 dark:group-hover:text-pink-400 transition-colors duration-300">
                                        {{ server.server_name }}
                                    </h3>
                                </div>
                            </a>
                            {% endfor %}
                            {% endwith %}
                        </div>
                    </div>
                    {% endif %}
                        {% endif %}

                    <!-- Enhanced Download Links Section with Dropdown -->
                    {% if not episode_data.error %}
                        {% if episode_data.data.download_links or episode_data.data.data.download_links %}
                    <div class="modern-card bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl md:rounded-3xl shadow-2xl overflow-hidden mb-8 sm:mb-12 p-4 sm:p-6 md:p-8 border border-gray-200/20 dark:border-gray-700/20 hover:shadow-3xl transition-all duration-700">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 sm:mb-8">
                            <div class="flex items-center mb-4 sm:mb-0">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-indigo-500 to-blue-600 dark:from-indigo-600 dark:to-blue-700 rounded-xl sm:rounded-2xl flex items-center justify-center mr-3 sm:mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 md:h-7 md:w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 dark:text-white">💾 Download Links</h2>
                                    <p class="text-sm sm:text-base text-gray-600 dark:text-gray-400">Download this episode in various formats and qualities</p>
                                </div>
                            </div>
                            <button id="downloadToggle" class="flex items-center text-xs sm:text-sm text-gray-500 dark:text-gray-400 bg-indigo-100 dark:bg-gray-700 px-3 sm:px-4 py-2 rounded-full hover:bg-indigo-200 dark:hover:bg-gray-600 transition-colors duration-300">
                                <span class="mr-2">{{ episode_data.data.download_links|default:episode_data.data.data.download_links|length }} Format{{ episode_data.data.download_links|default:episode_data.data.data.download_links|length|pluralize }}</span>
                                <svg id="downloadChevron" class="w-4 h-4 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>

                        <div id="downloadContent" class="space-y-6 sm:space-y-8 hidden">
                            {% if episode_data.error %}
                            <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/30 rounded-lg p-4">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-red-700 dark:text-red-300">Download links are not available due to an error.</p>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            {% with download_links=episode_data.data.download_links|default:episode_data.data.data.download_links %}
                            {% for format_type, resolutions in download_links.items %}
                            <div class="modern-card bg-gradient-to-br from-indigo-50 to-blue-50 dark:from-gray-700 dark:to-gray-800 p-6 rounded-2xl border border-indigo-200/50 dark:border-gray-600/50">
                                <div class="flex items-center mb-6">
                                    <div class="w-8 h-8 bg-gradient-to-r from-indigo-500 to-blue-600 dark:from-indigo-600 dark:to-blue-700 rounded-lg flex items-center justify-center mr-3">
                                        <span class="text-white font-bold text-sm">{{ format_type|slice:":1"|upper }}</span>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-800 dark:text-white">{{ format_type }}</h3>
                                </div>
                                
                                <div class="space-y-6">
                                    {% for resolution, links in resolutions.items %}
                                    <div class="bg-white/70 dark:bg-gray-800/70 p-4 rounded-xl border border-indigo-100/50 dark:border-gray-600/50">
                                        <div class="flex items-center mb-4">
                                            <div class="w-6 h-6 bg-gradient-to-r from-indigo-400 to-blue-500 rounded-lg flex items-center justify-center mr-3">
                                                <span class="text-white font-bold text-xs">{{ resolution|slice:":1" }}</span>
                                            </div>
                                            <h4 class="text-lg font-semibold text-gray-800 dark:text-white">{{ resolution }}</h4>
                                        </div>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                            {% for link in links %}
                                            <a href="{{ link.url }}" target="_blank" class="group block">
                                                <div class="modern-card bg-gradient-to-br from-white to-gray-50 dark:from-gray-700 dark:to-gray-800 p-4 rounded-xl border border-gray-200/50 dark:border-gray-600/50 hover:shadow-lg transition-all duration-300 group-hover:scale-105 group-hover:-translate-y-1">
                                                    <div class="flex items-center justify-center">
                                                        <div class="w-8 h-8 bg-gradient-to-r from-indigo-500 to-blue-600 dark:from-indigo-600 dark:to-blue-700 rounded-lg flex items-center justify-center mr-3 group-hover:scale-110 transition-transform duration-300">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor">
                                                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                                            </svg>
                                                        </div>
                                                        <span class="font-semibold text-gray-800 dark:text-white group-hover:text-indigo-600 dark:group-hover:text-blue-400 transition-colors duration-300">{{ link.provider }}</span>
                                                    </div>
                                                </div>
                                            </a>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                            {% endwith %}
                        </div>
                    </div>
                    {% endif %}
                        {% endif %}
                    
                    <!-- Enhanced Other Episodes Section -->
                    {% if not episode_data.error %}
                        {% if episode_data.data.other_episodes or episode_data.data.data.other_episodes %}
                    <div class="modern-card bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden mb-12 p-8 border border-gray-200/20 dark:border-gray-700/20 hover:shadow-3xl transition-all duration-700">
                        <div class="flex items-center justify-between mb-8">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-gradient-to-r from-emerald-500 to-teal-600 dark:from-emerald-600 dark:to-teal-700 rounded-2xl flex items-center justify-center mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white"> Other Episodes</h2>
                                    <p class="text-gray-600 dark:text-gray-400">Continue watching from this series</p>
                                </div>
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 bg-emerald-100 dark:bg-gray-700 px-4 py-2 rounded-full">
                                {{ episode_data.data.other_episodes|default:episode_data.data.data.other_episodes|length }} Episode{{ episode_data.data.other_episodes|default:episode_data.data.data.other_episodes|length|pluralize }}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                            {% with other_episodes=episode_data.data.other_episodes|default:episode_data.data.data.other_episodes %}
                            {% for episode in other_episodes %}
                                {% if episode.encoded_id %}
                                <a href="{% url 'stream:episode_detail' encoded_id=episode.encoded_id %}" class="block">
                                    {% include 'stream/includes/episode_card.html' with episode=episode %}
                                </a>
                                {% else %}
                                {% with episode_data=episode.url|make_dict:"episode_url" %}
                                <a href="{% url 'stream:episode_detail' encoded_id=episode_data|encode_episode_id:category|default:'' %}" class="block">
                                    {% include 'stream/includes/episode_card.html' with episode=episode %}
                                </a>
                                {% endwith %}
                                {% endif %}
                            
                            {% endfor %}
                            {% endwith %}
                        </div>
                    </div>
                    {% endif %}
                        {% endif %}
                    {% endif %}
                    
                {% else %}
                    <!-- No Data Available -->
                    <div class="bg-white dark:bg-korteks-darkgray border-l-4 border-gold-500 dark:border-korteks-red p-6 rounded-lg shadow-md">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-lg font-medium text-gray-800 dark:text-white">No episode data available</h3>
                                <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                    We couldn't find any information for this episode.
                                </p>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
{% if not error_occurred %}
    <!-- Optimized player loading with lazy loading -->
    <script defer src="{% static 'js/episode_player_lazy.js' %}"></script>

    <!-- Episode Data for JS -->
    <script type="application/json" id="episode-data-json">
        {
            "id": "{{ encoded_id|default:episode_identifier }}",
            {% if episode_data.error %}
            "title": "Error loading episode",
            "animeTitle": "Unknown anime",
            "coverUrl": "",
            {% else %}
            "title": "{{ episode_data.data.title|default:episode_data.data.data.title|default:'Episode'|escapejs }}",
            "animeTitle": "{{ episode_data.data.anime_info.title|default:episode_data.data.data.anime_info.title|default:'Anime'|escapejs }}",
            "coverUrl": "{{ episode_data.data.anime_info.thumbnail_url|default:episode_data.data.data.anime_info.thumbnail_url|default:'' }}",
            {% endif %}
            "url": "{{ request.build_absolute_uri }}",
            "category": "{{ category }}"
        }
    </script>

    <!-- Main Page Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- History Tracking Logic ---
            const episodeDataElement = document.getElementById('episode-data-json');
            const episodeData = JSON.parse(episodeDataElement.textContent);
            let hasBeenAddedToHistory = false;

            function trackPlayerForHistory(player) {
                if (!player) return;
                player.on('timeupdate', () => {
                    if (!hasBeenAddedToHistory && player.currentTime > 30) {
                        addToHistory(episodeData);
                        hasBeenAddedToHistory = true;
                        player.off('timeupdate'); // Remove listener after adding
                    }
                });
            }

            function addIframeToHistory() {
                if (!hasBeenAddedToHistory) {
                    console.log('Adding to history for iframe player.');
                    addToHistory(episodeData);
                    hasBeenAddedToHistory = true;
                }
            }

            // --- Existing Page Logic ---

            // Download section toggle
            const downloadToggle = document.getElementById('downloadToggle');
            const downloadContent = document.getElementById('downloadContent');
            const downloadChevron = document.getElementById('downloadChevron');

            if (downloadToggle && downloadContent && downloadChevron) {
                downloadToggle.addEventListener('click', function() {
                    downloadContent.classList.toggle('hidden');
                    downloadChevron.classList.toggle('rotate-180');
                });
            }

            // Streaming servers toggle
            const streamingToggle = document.getElementById('streamingToggle');
            const streamingContent = document.getElementById('streamingContent');
            const streamingChevron = document.getElementById('streamingChevron');

            if (streamingToggle && streamingContent && streamingChevron) {
                streamingToggle.addEventListener('click', function() {
                    streamingContent.classList.toggle('hidden');
                    streamingChevron.classList.toggle('rotate-180');
                });
            }

            // Synopsis toggle functionality
            function setupSynopsisToggle(textId, toggleId) {
                const synopsisText = document.getElementById(textId);
                const synopsisToggle = document.getElementById(toggleId);

                if (synopsisText && synopsisToggle) {
                    if (window.innerWidth < 768) {
                        synopsisText.classList.add('synopsis-collapsed');
                    }
                    synopsisToggle.addEventListener('click', function() {
                        synopsisText.classList.toggle('synopsis-collapsed');
                        this.textContent = synopsisText.classList.contains('synopsis-collapsed') ? 'Show more' : 'Show less';
                    });
                }
            }

            setupSynopsisToggle('synopsisTextEpisode', 'synopsisToggleEpisode');
            setupSynopsisToggle('synopsisTextEpisodeNested', 'synopsisToggleEpisodeNested');

            // --- Player Setup Logic (with history tracking hooks) ---

            // Function for the flat structure player
            function setupVideoPlayerFlat(url, serverName) {
                const playerWrapper = document.getElementById('player-wrapper-flat');
                const hlsWrapper = document.getElementById('hls-player-wrapper-flat');
                const iframeWrapper = document.getElementById('iframe-player-wrapper-flat');
                
                [playerWrapper, hlsWrapper, iframeWrapper].forEach(w => w.style.display = 'none');

                if (url.includes('.m3u8')) {
                    hlsWrapper.style.display = 'block';
                    const video = document.getElementById('hls-player-flat');
                    if (Hls.isSupported()) {
                        const hls = new Hls();
                        hls.loadSource(url);
                        hls.attachMedia(video);
                        const player = new Plyr(video);
                        trackPlayerForHistory(player);
                    }
                } else if (url.includes('.mp4')) {
                    playerWrapper.style.display = 'block';
                    const video = document.getElementById('player-flat');
                    video.src = url;
                    const player = new Plyr(video);
                    trackPlayerForHistory(player);
                } else {
                    iframeWrapper.style.display = 'block';
                    const iframe = document.getElementById('iframe-player-flat');
                    iframe.src = url;
                    addIframeToHistory(); // Fallback for iframes
                }
            }

            // Function for the nested structure player
            function setupVideoPlayerNested(url, serverName) {
                const playerWrapper = document.getElementById('player-wrapper-nested');
                const hlsWrapper = document.getElementById('hls-player-wrapper-nested');
                const iframeWrapper = document.getElementById('iframe-player-wrapper-nested');

                [playerWrapper, hlsWrapper, iframeWrapper].forEach(w => w.style.display = 'none');

                if (url.includes('.m3u8')) {
                    hlsWrapper.style.display = 'block';
                    const video = document.getElementById('hls-player-nested');
                    if (Hls.isSupported()) {
                        const hls = new Hls();
                        hls.loadSource(url);
                        hls.attachMedia(video);
                        const player = new Plyr(video);
                        trackPlayerForHistory(player);
                    }
                } else if (url.includes('.mp4')) {
                    playerWrapper.style.display = 'block';
                    const video = document.getElementById('player-nested');
                    video.src = url;
                    const player = new Plyr(video);
                    trackPlayerForHistory(player);
                } else {
                    iframeWrapper.style.display = 'block';
                    const iframe = document.getElementById('iframe-player-nested');
                    iframe.src = url;
                    addIframeToHistory(); // Fallback for iframes
                }
            }

            // Event listeners for server dropdowns
            const serverDropdownFlat = document.getElementById('server-dropdown-flat');
            if (serverDropdownFlat) {
                serverDropdownFlat.addEventListener('change', function() {
                    const selected = this.options[this.selectedIndex];
                    setupVideoPlayerFlat(selected.value, selected.dataset.serverName);
                });
                if (serverDropdownFlat.options.length > 0) {
                    const first = serverDropdownFlat.options[0];
                    setupVideoPlayerFlat(first.value, first.dataset.serverName);
                }
            }

            const serverDropdownNested = document.getElementById('server-dropdown-nested');
            if (serverDropdownNested) {
                serverDropdownNested.addEventListener('change', function() {
                    const selected = this.options[this.selectedIndex];
                    setupVideoPlayerNested(selected.value, selected.dataset.serverName);
                });
                if (serverDropdownNested.options.length > 0) {
                    const first = serverDropdownNested.options[0];
                    setupVideoPlayerNested(first.value, first.dataset.serverName);
                }
            }
        });
    </script>
{% endif %}
{% endblock extra_js %}
