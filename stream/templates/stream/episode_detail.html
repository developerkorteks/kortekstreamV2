{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}
    {% if episode_data.data.title %}
        {{ episode_data.data.title }} | KortekStream
    {% else %}
        Episode Detail | KortekStream
    {% endif %}
{% endblock title %}

{% block extra_css %}
    <style>
        .card-img-top {
            height: 250px;
            object-fit: cover;
        }
        .anime-cover {
            height: 400px;
            object-fit: cover;
        }
        .episode-card {
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        .light .episode-card:hover {
            transform: translateY(-4px);
            border-color: #FFBF00;
            box-shadow: 0 10px 20px rgba(255, 191, 0, 0.15);
        }
        .dark .episode-card:hover {
            transform: translateY(-4px);
            border-color: #E50914;
            box-shadow: 0 10px 20px rgba(229, 9, 20, 0.15);
        }
        .badge {
            @apply px-2 py-1 rounded-full text-xs font-semibold;
        }
        .light .badge-primary {
            @apply bg-gold-100 text-gold-800;
        }
        .dark .badge-primary {
            @apply bg-korteks-darkgray text-korteks-red;
        }
        .section-divider {
            @apply h-px;
        }
        .light .section-divider {
            @apply bg-gradient-to-r from-gold-400 to-transparent;
        }
        .dark .section-divider {
            @apply bg-gradient-to-r from-korteks-red to-transparent;
        }
        .server-button {
            @apply px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center;
        }
        .light .server-button {
            @apply bg-gold-50 text-gold-800 hover:bg-gold-100 border border-gold-200;
        }
        .dark .server-button {
            @apply bg-korteks-darkgray text-white hover:bg-korteks-gray border border-korteks-gray;
        }
        .light .server-button.active {
            @apply bg-gold-500 text-white border-gold-600;
        }
        .dark .server-button.active {
            @apply bg-korteks-red text-white border-korteks-red;
        }
        .download-button {
            @apply px-3 py-2 rounded-lg font-medium transition-all duration-200 flex items-center;
        }
        .light .download-button {
            @apply bg-gold-50 text-gold-800 hover:bg-gold-100 border border-gold-200;
        }
        .dark .download-button {
            @apply bg-korteks-darkgray text-white hover:bg-korteks-gray border border-korteks-gray;
        }
    </style>
{% endblock extra_css %}

{% block content %}
    <div class="min-h-screen">
        <!-- Include Navigation -->
        {% include 'components/navigation.html' %}

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            {% if error or episode_data.error %}
                <div class="bg-white dark:bg-korteks-darkgray border-l-4 border-gold-500 dark:border-korteks-red p-6 rounded-lg shadow-md">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-lg font-medium text-gray-800 dark:text-white">Something went wrong</h3>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                We're experiencing some issues. Please try again later.
                            </p>
                            {% if error_details and debug %}
                                <div class="mt-3 p-3 bg-red-50 dark:bg-red-900/20 rounded text-sm text-red-800 dark:text-red-300 font-mono">
                                    {{ error_details }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% else %}
                {% if episode_data.success and episode_data.data %}
                    <!-- API Response Metadata -->
                    {% if debug %}
                    <div class="mb-6 p-4 bg-gold-50 dark:bg-korteks-darkgray rounded-lg border border-gold-100 dark:border-korteks-gray">
                        <div class="flex items-center mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gold-500 dark:text-korteks-red mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                            <h3 class="font-semibold text-gray-800 dark:text-white">API Response Metadata</h3>
                        </div>
                        
                        <!-- Debug: Full Episode Data Structure -->
                        <div class="mt-4 p-3 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray overflow-auto max-h-96">
                            <h4 class="font-medium text-gold-700 dark:text-korteks-red mb-2">Full Episode Data Structure:</h4>
                            <pre class="text-xs text-gray-800 dark:text-gray-300 whitespace-pre-wrap">{{ episode_data|pprint }}</pre>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <!-- Handle both regular and nested gomunime structure -->
                            {% if episode_data.data.message %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Message:</span>
                                <span class="ml-2">{{ episode_data.data.message }}</span>
                            </div>
                            {% elif episode_data.data.data.message %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Message:</span>
                                <span class="ml-2">{{ episode_data.data.data.message }}</span>
                            </div>
                            {% endif %}
                            
                            {% if episode_data.data.sources %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Sources:</span>
                                <span class="ml-2">{{ episode_data.data.sources|join:", " }}</span>
                            </div>
                            {% elif episode_data.data.source %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Source:</span>
                                <span class="ml-2">{{ episode_data.data.source }}</span>
                            </div>
                            {% endif %}
                            
                            {% if episode_data.data.confidence_score %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Confidence Score:</span>
                                <span class="ml-2">{{ episode_data.data.confidence_score }}</span>
                            </div>
                            {% elif episode_data.data.data.confidence_score %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Confidence Score:</span>
                                <span class="ml-2">{{ episode_data.data.data.confidence_score }}</span>
                            </div>
                            {% endif %}
                            {% if episode_data.metadata %}
                            <div class="p-2 bg-white dark:bg-korteks-gray rounded border border-gold-100 dark:border-korteks-darkgray md:col-span-3">
                                <span class="font-medium text-gold-700 dark:text-korteks-red">Metadata:</span>
                                <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
                                    {% if episode_data.metadata.source %}
                                    <div class="text-xs bg-gold-50 dark:bg-korteks-darkgray p-1 rounded">
                                        <span class="font-medium">Source:</span> {{ episode_data.metadata.source }}
                                    </div>
                                    {% endif %}
                                    {% if episode_data.metadata.response_time %}
                                    <div class="text-xs bg-gold-50 dark:bg-korteks-darkgray p-1 rounded">
                                        <span class="font-medium">Response Time:</span> {{ episode_data.metadata.response_time }}
                                    </div>
                                    {% endif %}
                                    {% if episode_data.metadata.cache_status %}
                                    <div class="text-xs bg-gold-50 dark:bg-korteks-darkgray p-1 rounded">
                                        <span class="font-medium">Cache Status:</span> {{ episode_data.metadata.cache_status }}
                                    </div>
                                    {% endif %}
                                    {% if episode_data.metadata.timestamp %}
                                    <div class="text-xs bg-gold-50 dark:bg-korteks-darkgray p-1 rounded">
                                        <span class="font-medium">Timestamp:</span> {{ episode_data.metadata.timestamp }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Episode Header Section -->
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8 border border-transparent hover:border-gold-200 dark:hover:border-korteks-red transition-colors">
                        <div class="p-6">
                            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">
                                {% if episode_data.data.data.title %}
                                    {{ episode_data.data.data.title }}
                                {% else %}
                                    {{ episode_data.data.title }}
                                {% endif %}
                            </h1>
                            
                            <!-- Anime Info Section -->
                            {% if episode_data.data.anime_info %}
                            <div class="md:flex mb-6">
                                <!-- Thumbnail -->
                                <div class="md:w-1/3 lg:w-1/4 mb-4 md:mb-0">
                                    <img src="{{ episode_data.data.anime_info.thumbnail_url }}" 
                                         alt="{{ episode_data.data.anime_info.title }}" 
                                         class="w-full rounded-lg shadow-md"
                                         onerror="this.src='https://via.placeholder.com/300x450?text=No+Image';this.onerror='';">
                                </div>
                                
                                <!-- Anime Details -->
                                <div class="md:w-2/3 lg:w-3/4 md:pl-6">
                                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3">{{ episode_data.data.anime_info.title }}</h2>
                                    
                                    <!-- Genres -->
                                    {% if episode_data.data.anime_info.genres %}
                                    <div class="mb-4">
                                        <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Genres:</h3>
                                        <div class="flex flex-wrap gap-2">
                                            {% for genre in episode_data.data.anime_info.genres %}
                                                <span class="bg-gold-100 text-gold-800 dark:bg-korteks-gray dark:text-white px-3 py-1 rounded-full text-xs">
                                                    {{ genre }}
                                                </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Synopsis -->
                                    {% if episode_data.data.anime_info.synopsis %}
                                    <div>
                                        <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Synopsis:</h3>
                                        <p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
                                            {{ episode_data.data.anime_info.synopsis }}
                                        </p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% elif episode_data.data.data.anime_info %}
                            <!-- Nested structure for gomunime -->
                            <div class="md:flex mb-6">
                                <!-- Thumbnail -->
                                <div class="md:w-1/3 lg:w-1/4 mb-4 md:mb-0">
                                    <img src="{{ episode_data.data.data.anime_info.thumbnail_url }}" 
                                         alt="{{ episode_data.data.data.anime_info.title }}" 
                                         class="w-full rounded-lg shadow-md"
                                         onerror="this.src='https://via.placeholder.com/300x450?text=No+Image';this.onerror='';">
                                </div>
                                
                                <!-- Anime Details -->
                                <div class="md:w-2/3 lg:w-3/4 md:pl-6">
                                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3">{{ episode_data.data.data.anime_info.title }}</h2>
                                    
                                    <!-- Genres -->
                                    {% if episode_data.data.data.anime_info.genres %}
                                    <div class="mb-4">
                                        <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Genres:</h3>
                                        <div class="flex flex-wrap gap-2">
                                            {% for genre in episode_data.data.data.anime_info.genres %}
                                                <span class="bg-gold-100 text-gold-800 dark:bg-korteks-gray dark:text-white px-3 py-1 rounded-full text-xs">
                                                    {{ genre }}
                                                </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Synopsis -->
                                    {% if episode_data.data.data.anime_info.synopsis %}
                                    <div>
                                        <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Synopsis:</h3>
                                        <p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
                                            {{ episode_data.data.data.anime_info.synopsis }}
                                        </p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Navigation Links -->
                            {% if episode_data.data.navigation %}
                            <div class="flex flex-wrap gap-3 mb-6">
                                {% if episode_data.data.navigation.all_episodes_url %}
                                <a href="{% url 'stream:anime_detail' %}?anime_slug={{ episode_data.data.data.anime_info.title|slugify }}&category={{ category }}" 
                                   class="bg-gold-500 hover:bg-gold-600 dark:bg-korteks-red dark:hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
                                    </svg>
                                    All Episodes
                                </a>
                                {% endif %}
                                
                                {% if episode_data.data.navigation.previous_episode_url %}
                                {% if episode_data.data.navigation.previous_episode_encoded_id and episode_data.data.navigation.previous_episode_encoded_id != '' %}
                                <a href="{% url 'stream:episode_detail' encoded_id=episode_data.data.navigation.previous_episode_encoded_id %}"
                                   class="server-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Previous Episode
                                </a>
                                {% else %}
                                <a href="{% url 'stream:episode_detail_legacy' %}?episode_url={{ episode_data.data.navigation.previous_episode_url|urlencode }}&category={{ category }}"
                                   class="server-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Previous Episode (External)
                                </a>
                                {% endif %}
                                {% endif %}
                                
                                {% if episode_data.data.navigation.next_episode_url %}
                                {% if episode_data.data.navigation.next_episode_encoded_id and episode_data.data.navigation.next_episode_encoded_id != '' %}
                                <a href="{% url 'stream:episode_detail' encoded_id=episode_data.data.navigation.next_episode_encoded_id %}"
                                   class="server-button">
                                    Next Episode
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </a>
                                {% else %}
                                <a href="{% url 'stream:episode_detail_legacy' %}?episode_url={{ episode_data.data.navigation.next_episode_url|urlencode }}&category={{ category }}"
                                   class="server-button">
                                    Next Episode (External)
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </a>
                                {% endif %}
                                {% endif %}
                            </div>
                            {% elif episode_data.data.data.navigation %}
                            <!-- Nested structure for gomunime navigation -->
                            <div class="flex flex-wrap gap-3 mb-6">
                                {% if episode_data.data.data.navigation.all_episodes_url %}
                                <a href="{% url 'stream:anime_detail' %}?anime_slug={{ episode_data.data.data.anime_info.title|slugify }}&category={{ category }}" 
                                   class="bg-gold-500 hover:bg-gold-600 dark:bg-korteks-red dark:hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
                                    </svg>
                                    All Episodes
                                </a>
                                {% endif %}
                                
                                {% if episode_data.data.data.navigation.previous_episode_url %}
                                {% if episode_data.data.data.navigation.previous_episode_encoded_id and episode_data.data.data.navigation.previous_episode_encoded_id != '' %}
                                <a href="{% url 'stream:episode_detail' encoded_id=episode_data.data.data.navigation.previous_episode_encoded_id %}"
                                   class="server-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Previous Episode
                                </a>
                                {% else %}
                                <a href="{% url 'stream:episode_detail_legacy' %}?episode_url={{ episode_data.data.data.navigation.previous_episode_url|urlencode }}&category={{ category }}"
                                   class="server-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Previous Episode (External)
                                </a>
                                {% endif %}
                                {% endif %}
                                
                                {% if episode_data.data.data.navigation.next_episode_url %}
                                {% if episode_data.data.data.navigation.next_episode_encoded_id and episode_data.data.data.navigation.next_episode_encoded_id != '' %}
                                <a href="{% url 'stream:episode_detail' encoded_id=episode_data.data.data.navigation.next_episode_encoded_id %}"
                                   class="server-button">
                                    Next Episode
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </a>
                                {% else %}
                                <a href="{% url 'stream:episode_detail_legacy' %}?episode_url={{ episode_data.data.data.navigation.next_episode_url|urlencode }}&category={{ category }}"
                                   class="server-button">
                                    Next Episode (External)
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </a>
                                {% endif %}
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Video Player Section -->
                    {% if episode_data.data.embed_url %}
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8">
                        <div class="p-4 border-b border-gray-200 dark:border-korteks-gray">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Video Player (Embed)
                            </h2>
                        </div>
                        <div class="relative" style="padding-top: 56.25%;">
                            <iframe src="{{ episode_data.data.embed_url }}" 
                                    class="absolute top-0 left-0 w-full h-full" 
                                    frameborder="0" 
                                    allowfullscreen>
                            </iframe>
                        </div>
                    </div>
                    {% elif episode_data.data.video_url %}
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8">
                        <div class="p-4 border-b border-gray-200 dark:border-korteks-gray">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Video Player (Direct)
                            </h2>
                        </div>
                        <div class="relative" style="padding-top: 56.25%;">
                            <video src="{{ episode_data.data.video_url }}" 
                                   class="absolute top-0 left-0 w-full h-full" 
                                   controls 
                                   preload="metadata">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    </div>
                    {% elif episode_data.data.streaming_servers and episode_data.data.streaming_servers.0.streaming_url %}
                    <!-- For gomunime format (flat structure) -->
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8">
                        <div class="p-4 border-b border-gray-200 dark:border-korteks-gray">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Video Player (Embed)
                            </h2>
                        </div>
                        
                        <!-- Server Selection Tabs -->
                        <div class="p-4 bg-gray-50 dark:bg-korteks-gray border-b border-gray-200 dark:border-korteks-darkgray">
                            <div class="flex flex-wrap gap-2">
                                {% for server in episode_data.data.streaming_servers %}
                                <button 
                                    onclick="changeServerFlat('{{ server.streaming_url }}')" 
                                    class="px-3 py-1 text-sm rounded-md {% if forloop.first %}bg-gold-500 text-white dark:bg-korteks-red{% else %}bg-gray-200 text-gray-700 dark:bg-korteks-darkgray dark:text-gray-300{% endif %} hover:bg-gold-400 dark:hover:bg-red-700 transition-colors">
                                    {{ server.server_name }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="relative" style="padding-top: 56.25%;">
                            <iframe id="video-player-iframe-flat" 
                                    src="{{ episode_data.data.streaming_servers.0.streaming_url }}" 
                                    class="absolute top-0 left-0 w-full h-full" 
                                    frameborder="0" 
                                    allowfullscreen>
                            </iframe>
                        </div>
                        
                        <!-- JavaScript for server switching -->
                        <script>
                            function changeServerFlat(url) {
                                document.getElementById('video-player-iframe-flat').src = url;
                                
                                // Update button styles
                                const buttons = document.querySelectorAll('.p-4.bg-gray-50 button');
                                buttons.forEach(button => {
                                    if (button.getAttribute('onclick').includes(url)) {
                                        button.classList.add('bg-gold-500', 'text-white', 'dark:bg-korteks-red');
                                        button.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-korteks-darkgray', 'dark:text-gray-300');
                                    } else {
                                        button.classList.remove('bg-gold-500', 'text-white', 'dark:bg-korteks-red');
                                        button.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-korteks-darkgray', 'dark:text-gray-300');
                                    }
                                });
                            }
                        </script>
                    </div>
                    
                    <!-- Other Episodes Section for Gomunime (flat structure) -->
                    {% if episode_data.data.other_episodes %}
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8">
                        <div class="p-4 border-b border-gray-200 dark:border-korteks-gray">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                                </svg>
                                Other Episodes ({{ episode_data.data.other_episodes|length }})
                            </h2>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                {% for episode in episode_data.data.other_episodes %}
                                <a href="{% url 'stream:episode_detail_legacy' %}?episode_url={{ episode.url|urlencode }}&category={{ category }}" class="block group">
                                    <div class="bg-gray-50 dark:bg-korteks-gray rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                                        <div class="relative pb-[56.25%]">
                                            <img src="{{ episode.thumbnail_url }}" 
                                                 alt="{{ episode.title }}" 
                                                 class="absolute top-0 left-0 w-full h-full object-cover group-hover:opacity-90 transition-opacity"
                                                 onerror="this.src='https://via.placeholder.com/300x169?text=No+Image';this.onerror='';">
                                        </div>
                                        <div class="p-3">
                                            <h3 class="text-sm font-medium text-gray-800 dark:text-white truncate group-hover:text-gold-600 dark:group-hover:text-korteks-red transition-colors">
                                                {{ episode.title }}
                                            </h3>
                                            {% if episode.release_date %}
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                {{ episode.release_date }}
                                            </p>
                                            {% endif %}
                                            
                                            <!-- Extract episode number from URL if possible -->
                                            {% if episode.url %}
                                                {% with url_parts=episode.url|split:"-" %}
                                                    {% if url_parts|length > 0 %}
                                                        {% with last_part=url_parts|last %}
                                                            {% if last_part|slice:":3" == "sub" %}
                                                                <!-- URL ends with "sub-indo/" -->
                                                                {% with ep_num=url_parts|slice:"-2:-1"|first %}
                                                                    <p class="text-xs font-semibold text-gold-600 dark:text-korteks-red mt-1">
                                                                        Episode: {{ ep_num }}
                                                                    </p>
                                                                {% endwith %}
                                                            {% else %}
                                                                <!-- URL might end with episode number -->
                                                                <p class="text-xs font-semibold text-gold-600 dark:text-korteks-red mt-1">
                                                                    Episode: {{ last_part|slice:":-1" }}
                                                                </p>
                                                            {% endif %}
                                                        {% endwith %}
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% elif episode_data.data.data.streaming_servers and episode_data.data.data.streaming_servers.0.streaming_url %}
                    <!-- For gomunime format (nested structure) -->
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8">
                        <div class="p-4 border-b border-gray-200 dark:border-korteks-gray">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Video Player (Embed)
                            </h2>
                        </div>
                        
                        <!-- Server Selection Tabs -->
                        <div class="p-4 bg-gray-50 dark:bg-korteks-gray border-b border-gray-200 dark:border-korteks-darkgray">
                            <div class="flex flex-wrap gap-2">
                                {% for server in episode_data.data.data.streaming_servers %}
                                <button 
                                    onclick="changeServer('{{ server.streaming_url }}')" 
                                    class="px-3 py-1 text-sm rounded-md {% if forloop.first %}bg-gold-500 text-white dark:bg-korteks-red{% else %}bg-gray-200 text-gray-700 dark:bg-korteks-darkgray dark:text-gray-300{% endif %} hover:bg-gold-400 dark:hover:bg-red-700 transition-colors">
                                    {{ server.server_name }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="relative" style="padding-top: 56.25%;">
                            <iframe id="video-player-iframe" 
                                    src="{{ episode_data.data.data.streaming_servers.0.streaming_url }}" 
                                    class="absolute top-0 left-0 w-full h-full" 
                                    frameborder="0" 
                                    allowfullscreen>
                            </iframe>
                        </div>
                        
                        <!-- JavaScript for server switching -->
                        <script>
                            function changeServer(url) {
                                document.getElementById('video-player-iframe').src = url;
                                
                                // Update button styles
                                const buttons = document.querySelectorAll('.p-4.bg-gray-50 button');
                                buttons.forEach(button => {
                                    if (button.getAttribute('onclick').includes(url)) {
                                        button.classList.add('bg-gold-500', 'text-white', 'dark:bg-korteks-red');
                                        button.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-korteks-darkgray', 'dark:text-gray-300');
                                    } else {
                                        button.classList.remove('bg-gold-500', 'text-white', 'dark:bg-korteks-red');
                                        button.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-korteks-darkgray', 'dark:text-gray-300');
                                    }
                                });
                            }
                        </script>
                    </div>
                    
                    <!-- Other Episodes Section for Gomunime -->
                    {% if episode_data.data.data.other_episodes %}
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8">
                        <div class="p-4 border-b border-gray-200 dark:border-korteks-gray">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                                </svg>
                                Other Episodes ({{ episode_data.data.data.other_episodes|length }})
                            </h2>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                {% for episode in episode_data.data.data.other_episodes %}
                                <a href="{% url 'stream:episode_detail_legacy' %}?episode_url={{ episode.url|urlencode }}&category={{ category }}" class="block group">
                                    <div class="bg-gray-50 dark:bg-korteks-gray rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                                        <div class="relative pb-[56.25%]">
                                            <img src="{{ episode.thumbnail_url }}" 
                                                 alt="{{ episode.title }}" 
                                                 class="absolute top-0 left-0 w-full h-full object-cover group-hover:opacity-90 transition-opacity"
                                                 onerror="this.src='https://via.placeholder.com/300x169?text=No+Image';this.onerror='';">
                                        </div>
                                        <div class="p-3">
                                            <h3 class="text-sm font-medium text-gray-800 dark:text-white truncate group-hover:text-gold-600 dark:group-hover:text-korteks-red transition-colors">
                                                {{ episode.title }}
                                            </h3>
                                            {% if episode.release_date %}
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                {{ episode.release_date }}
                                            </p>
                                            {% endif %}
                                            
                                            <!-- Extract episode number from URL if possible -->
                                            {% if episode.url %}
                                                {% with url_parts=episode.url|split:"-" %}
                                                    {% if url_parts|length > 0 %}
                                                        {% with last_part=url_parts|last %}
                                                            {% if last_part|slice:":3" == "sub" %}
                                                                <!-- URL ends with "sub-indo/" -->
                                                                {% with ep_num=url_parts|slice:"-2:-1"|first %}
                                                                    <p class="text-xs font-semibold text-gold-600 dark:text-korteks-red mt-1">
                                                                        Episode: {{ ep_num }}
                                                                    </p>
                                                                {% endwith %}
                                                            {% else %}
                                                                <!-- URL might end with episode number -->
                                                                <p class="text-xs font-semibold text-gold-600 dark:text-korteks-red mt-1">
                                                                    Episode: {{ last_part|slice:":-1" }}
                                                                </p>
                                                            {% endif %}
                                                        {% endwith %}
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% elif episode_data.data.episode_url or episode_identifier %}
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8 p-6">
                        <div class="text-center">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">External Video Source</h2>
                            <p class="text-gray-600 dark:text-gray-300 mb-4">
                                This episode is available on an external site. Click the button below to watch it.
                            </p>
                            <a href="{{ episode_data.data.episode_url|default:episode_identifier }}" target="_blank" 
                               class="inline-flex items-center px-6 py-3 bg-gold-500 dark:bg-korteks-red text-white font-medium rounded-lg hover:bg-gold-600 dark:hover:bg-red-700 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                </svg>
                                Watch on External Site
                            </a>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Streaming Servers Section -->
                    {% if episode_data.data.streaming_servers %}
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8 p-6">
                        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Streaming Servers
                        </h2>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                            {% for server in episode_data.data.streaming_servers %}
                            <a href="{{ server.streaming_url }}" target="_blank" class="server-button">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                </svg>
                                {{ server.server_name }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Download Links Section -->
                    {% if episode_data.data.download_links %}
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8 p-6">
                        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Download Links
                        </h2>
                        
                        <div class="space-y-4">
                            {% for format_type, resolutions in episode_data.data.download_links.items %}
                            <div class="bg-gold-50 dark:bg-korteks-gray/20 p-4 rounded-lg">
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">{{ format_type }}</h3>
                                
                                <div class="space-y-3">
                                    {% for resolution, links in resolutions.items %}
                                    <div>
                                        <h4 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">{{ resolution }}</h4>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                                            {% for link in links %}
                                            <a href="{{ link.url }}" target="_blank" class="download-button">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                                </svg>
                                                {{ link.provider }}
                                            </a>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Other Episodes Section -->
                    {% if episode_data.data.other_episodes %}
                    <div class="bg-white dark:bg-korteks-darkgray rounded-xl shadow-lg overflow-hidden mb-8 p-6">
                        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                            </svg>
                            Other Episodes
                        </h2>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            {% for episode in episode_data.data.other_episodes %}
                                {% if episode.encoded_id %}
                                <a href="{% url 'stream:episode_detail' encoded_id=episode.encoded_id %}" class="block">
                                    <div class="bg-gold-50 dark:bg-korteks-gray/20 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow episode-card">
                                        {% if episode.thumbnail_url %}
                                        <img src="{{ episode.thumbnail_url }}" alt="{{ episode.title }}" class="w-full h-32 object-cover">
                                        {% endif %}
                                        <div class="p-3">
                                            <h3 class="font-medium text-gray-800 dark:text-white text-sm mb-1 line-clamp-2">{{ episode.title }}</h3>
                                            {% if episode.release_date %}
                                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ episode.release_date }}</p>
                                            {% endif %}
                                            <div class="mt-2 text-gold-600 dark:text-korteks-red text-xs">
                                                Watch Episode
                                            </div>
                                        </div>
                                    </div>
                                </a>
                                {% else %}
                                {% with episode_data=episode.url|make_dict:"episode_url" %}
                                <a href="{% url 'stream:episode_detail' encoded_id=episode_data|encode_episode_id:category|default:'' %}" class="block">
                                    <div class="bg-gold-50 dark:bg-korteks-gray/20 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow episode-card">
                                        {% if episode.thumbnail_url %}
                                        <img src="{{ episode.thumbnail_url }}" alt="{{ episode.title }}" class="w-full h-32 object-cover">
                                        {% endif %}
                                        <div class="p-3">
                                            <h3 class="font-medium text-gray-800 dark:text-white text-sm mb-1 line-clamp-2">{{ episode.title }}</h3>
                                            {% if episode.release_date %}
                                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ episode.release_date }}</p>
                                            {% endif %}
                                            <div class="mt-2 text-gold-600 dark:text-korteks-red text-xs">
                                                Watch Episode
                                            </div>
                                        </div>
                                    </div>
                                </a>
                                {% endwith %}
                                {% endif %}
                            
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                {% else %}
                    <!-- No Data Available -->
                    <div class="bg-white dark:bg-korteks-darkgray border-l-4 border-gold-500 dark:border-korteks-red p-6 rounded-lg shadow-md">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-gold-500 dark:text-korteks-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-lg font-medium text-gray-800 dark:text-white">No episode data available</h3>
                                <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                    We couldn't find any information for this episode.
                                </p>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
{% endblock content %}
